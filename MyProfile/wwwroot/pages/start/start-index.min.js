var StartVue=new Vue({el:"#start-vue",data:{userInfo:{name:null,workHours:0,allWorkHours:0,allWorkDays:0},areas:[{id:0,name:"Расходы",codeName:"Spendings",sections:[]},{id:1,name:"Доходы",codeName:"Earnings",sections:[]},{id:2,name:"Инвестиции",codename:"Investments",sections:[]}],sectionSource:[],section:{},userSectionSource:[],icons:[],colors:[],template:{columns:[]},sections:[],column:{},startColumnsName:"Новая колонка",limit:{},limits:[],periodTypes:[{codeName:"Days",id:1,isUsing:!1,name:"на месяц"},{codeName:"Month",id:3,isUsing:!1,name:"на год"}],goal:{},goals:[],flatpickrStart:{},flatpickrEnd:{},isSaving:!1,errorMessage:null,counter:-999,isShowButtonSkip:!1},watch:{},computed:{sectionComponent_step2:function(){return this.$children[0]}},mounted:function(){let n=$("#start-vue").smartWizard({autoAdjustHeight:!1,backButtonSupport:!1,useURLhash:!1,showStepURLhash:!1,keyNavigation:!1,lang:{next:"Вперед"},toolbarSettings:{toolbarPosition:"bottom",toolbarButtonPosition:"center",showNextButton:!0,showPreviousButton:!1},keyboardSettings:{keyNavigation:!1}});n.on("leaveStep",function(n,t,i,r){if(r=="backward")return!1;let u=!0;if(StartVue.errorMessage=null,StartVue.isShowButtonSkip=!1,i==0&&r=="forward"&&(StartVue.checkUserForm()?($("#userInfoName").removeClass("is-invalid"),u=!0,StartVue.saveUserInfo(),$("#work-hours, #work-days").attr({title:"","data-original-title":""}),$("#work-hours").tooltip("dispose"),$("#work-days").tooltip("dispose"),$('[data-toggle="tooltip"]').tooltip("show")):($("#userInfoName").addClass("is-invalid"),u=!1)),i==1&&r=="forward"){u=!1;for(var f=0;f<StartVue.areas.length;f++)if(StartVue.areas[f].sections.length>0){u=!0;continue}u?(StartVue.saveSections(),StartVue.startStep3()):StartVue.errorMessage="Нужно выбрать хотя бы одну категорию."}return i==2&&r=="forward"&&(StartVue.validTemplate()?(StartVue.saveTemplate(),StartVue.isShowButtonSkip=!0):u=!1),i==3&&r=="forward"&&(StartVue.limits.length>0&&StartVue.saveLimits(),StartVue.isShowButtonSkip=!0),i==4&&r=="forward"&&(StartVue.goals.length>0&&StartVue.saveGoals(),StartVue.showStep5()),i==5&&r=="forward"&&(u=!1,console.log("finish")),$(".modal-backdrop").remove(),u});setTimeout(function(){$(".sw-btn-next").parent().removeClass("btn-group").addClass("d-inline-flex align-items-center");$(".sw-btn-next").removeClass("btn-secondary").addClass("btn-primary").before($("#button-skip"));$(".sw-btn-next").after($("#button-finish"))},100);this.loadUserInfo();this.loadSections();$.getJSON("/json/font-awesome.json",function(n){StartVue.icons=n});$.getJSON("/json/colors-section.json",function(n){StartVue.colors=n});$("#section-description, #choose-area, #show-on-the-main-page, #limit-comment, #goal-comment, #gaol-is-finish").hide();$(".layout-sidenav-toggle").remove();$(".isCashback-section").remove()},methods:{skip:function(){$("#start-vue").smartWizard("getStepIndex")==4&&this.showStep5();$("#start-vue").smartWizard("next")},showStep5:function(){this.isShowButtonSkip=!1;$("#button-skip").hide();$(".sw-btn-next").hide();$("#button-finish").show()},finish:function(){return StartVue.isSaving=!0,sendAjax("/Start/Finish","GET").then(function(n){n.isOk==!0&&(document.location.href="/Budget/Month");StartVue.isSaving=!1})},loadUserInfo:function(){return this.isSaving=!0,$.ajax({type:"GET",url:"/Start/LoadUserInfo",context:this,contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){return n.isOk&&(this.isSaving=!1,this.userInfo=n.userInfo,this.userInfo.timeZoneClient=Intl.DateTimeFormat().resolvedOptions().timeZone),$('[data-toggle="tooltip"]').tooltip("show"),!0},error:function(n,t,i){this.isSaving=!1;console.log(i)}})},saveUserInfo:function(){return this.isSaving=!0,$.ajax({type:"POST",url:"/Start/SaveUserInfo",context:this,data:JSON.stringify(this.userInfo),contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){return n.isOk&&(this.isSaving=!1,this.userInfo=n.user,UserInfo=n.user,$("#userName").html(this.userInfo.name)),!0},error:function(n,t,i){this.isSaving=!1;console.log(i)}})},checkUserForm:function(){let t=!0,n=this.userInfo.name;return n=n?n.replaceAll(" ",""):"",n.length==0?($("#userInfoName").addClass("is-invalid"),t=!1):($("#userInfoName").removeClass("is-invalid"),t=!0),t},loadSections:function(){return this.isSaving=!0,$.ajax({type:"GET",url:"/Start/LoadSections",context:this,contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){return n.isOk&&(this.isSaving=!1,this.sectionSource=n.sections),!0},error:function(n,t,i){this.isSaving=!1;console.log(i)}})},onChooseSection:function(n){n.isSelected?this.areas[n.areaID].sections.push(n):(this.areas[n.areaID].sections.splice(this.areas[n.areaID].sections.findIndex(t=>t.id==n.id),1),$('[data-toggle="tooltip"]').tooltip("dispose"))},selectAllSections:function(){this.sectionComponent_step2.selectAllSections()},addSection:function(){this.section={id:this.counter++,name:null,areaID:0,areaName:"Расходы",cssBackground:null,isShow:!0,isShowInCollective:!0,isShowOnSite:!0,isShow_Filtered:!0,sectionTypeID:2,hasRecords:!0,cssIcon:null,isSelected:!0,canEdit:!1,codeName:null,collectiveSections:[],description:null,isUpdated:!1,sectionTypeName:"Расходы",cssColor:"",canRemove:!0};this.chooseColor();$("#accordion2-2, #accordion2-1").removeClass("show");this.changeSectionType(2);$("#modal-section").modal("show")},onEditSection:function(n){console.log(n.sectionTypeID);this.section=JSCopyObject(n);this.chooseColor(this.section.cssBackground);$("#accordion2-2, #accordion2-1").removeClass("show");$("#modal-section").modal("show")},removeSection:function(){$("#modal-section").modal("hide");let n=this.userSectionSource.findIndex(n=>n.id==this.section.id);if(n>-1){this.userSectionSource.splice(n,1);for(var t=0;t<this.areas.length;t++)if(n=this.areas[t].sections.findIndex(n=>n.id==this.section.id),n>=0){this.areas[t].sections.splice(n,1);continue}}},saveSection:function(){if(this.validSection()){let t=this.userSectionSource.findIndex(n=>n.id==this.section.id);if(this.section.sectionTypeID==1?(this.section.areaID=1,this.section.areaName="Доходы"):this.section.sectionTypeID==2?(this.section.areaID=0,this.section.areaName="Расходы"):this.section.sectionTypeID==3&&(this.section.areaID=2,this.section.areaName="Инвестиции"),this.section.hasRecords=!1,t==-1)this.userSectionSource.push(this.section);else{this.userSectionSource[t].sectionTypeID=this.section.sectionTypeID;this.userSectionSource[t].name=this.section.name;this.userSectionSource[t].cssBackground=this.section.cssBackground;this.userSectionSource[t].cssColor=this.section.cssColor;this.userSectionSource[t].cssIcon=this.section.cssIcon;this.userSectionSource[t].areaID=this.section.areaID;this.userSectionSource[t].areaName=this.section.areaName;for(var n=0;n<this.areas.length;n++)if(t=this.areas[n].sections.findIndex(n=>n.id==this.section.id),t>=0){this.areas[n].sections.splice(t,1);continue}}this.areas[this.section.areaID].sections.push(this.section);$("#modal-section").modal("hide");this.section={}}},validSection:function(n){let t=!0;this.section.name&&this.section.name.length>0?$("#section-name").removeClass("is-invalid"):(t=!1,$("#section-name").addClass("is-invalid"));let i=this.section.name;return i=i?i.replaceAll(" ",""):"",i.length==0?(t=!1,$("#section-name").addClass("is-invalid")):$("#section-name").removeClass("is-invalid"),t==!1&&n&&n.preventDefault(),t},selectIcon:function(n){this.section.cssIcon=n.nameClass;$("#accordion2-2, #accordion2-1").removeClass("show")},checkSectionForm:function(n){let t=!0;return this.section.name&&this.section.name.length>0||(t=!1),t==!1&&n&&n.preventDefault(),t},changeSectionType:function(n){this.section.sectionTypeID=n},chooseColor:function(n){for(var t=0;t<this.colors.length;t++)this.colors[t].selected=!1;if(n){let t=this.colors.findIndex(t=>t.background==n);t!=-1&&(this.colors[t].selected=!0,this.section.cssColor=this.colors[t].color,this.section.cssBackground=this.colors[t].background);$("#accordion2-2, #accordion2-1").removeClass("show")}else this.section.cssColor="",this.section.cssBackground=""},saveSections:function(){return this.isSaving=!0,ShowLoading("#smartwizard-1-step-3"),$.ajax({type:"POST",url:"/Start/SaveSections",context:this,data:JSON.stringify(this.areas),contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){return n.isOk&&(this.isSaving=!1,this.sections=n.sections),HideLoading("#smartwizard-1-step-3"),!0},error:function(n,t,i){this.isSaving=!1;console.log(i);HideLoading("#smartwizard-1-step-3")}})},ONLY_FOR_TEST:function(){return $.ajax({type:"GET",url:"/Section/GetSectins",data:null,contentType:"application/json; charset=utf-8",dataType:"json",context:this,success:function(n){return n.isOk&&(this.sections=n.sections),n},error:function(n,t,i){console.log(i)}},this)},startStep3:function(){this.template.columns.length==0&&(column={id:-7777,name:"Дни",order:this.template.columns.length,isShow:!1,totalAction:0,formula:[],templateBudgetSections:[],placeAfterCommon:0,format:"dd",templateColumnType:TemplateColumnTypeEnum.DaysForMonth},this.template.columns.push(column))},addColumn:function(){if(this.template.columns&&this.template.columns.length>1&&this.template.columns[this.template.columns.length-1].templateBudgetSections.length==0)return this.errorMessage="Колонка должна содержать хотя бы одну категорию.",!1;this.errorMessage="";this.column={id:this.counter++,name:this.startColumnsName,order:this.template.columns.length,isShow:!0,totalAction:0,formula:[],templateBudgetSections:[],placeAfterCommon:0,format:"",templateColumnType:TemplateColumnTypeEnum.BudgetSection};this.template.columns.push(this.column);setTimeout(function(){$(".lists").scrollCenter("#add-column",300)},100)},selectColumn:function(n){n.id!=-7777&&(this.column=n)},removeColumnName:function(n){n.name=="Новая колонка"&&(n.name="")},templateOnSelectedSection:function(n){this.column&&this.column.formula&&(this.errorMessage="",this.column.formula.length>0?(this.column.formula.push({id:null,value:"+",type:FormulaFieldTypeEnum.Mark}),this.column.formula.push({id:n.id,value:`[ ${n.name} ]`,type:FormulaFieldTypeEnum.Section})):this.column.formula.push({id:n.id,value:`[ ${n.name} ]`,type:FormulaFieldTypeEnum.Section}),this.column.name==this.startColumnsName&&(this.column.name=n.name),this.column.templateBudgetSections.push({id:this.counter++,sectionID:n.id,sectionName:n.name}),setTimeout(function(){$('[data-toggle="popover"]').popover("disable").popover("enable").popover("show")},250))},getTitleCell:function(n){let i="";for(var t=0;t<n.templateBudgetSections.length;t++)t==0?i=" "+n.templateBudgetSections[t].sectionName:i+=" + "+n.templateBudgetSections[t].sectionName;return i},removeSectionInColumn:function(n,t){this.column.templateBudgetSections.splice(t,1);this.column.formula=[];for(var i=0;i<this.column.templateBudgetSections.length;i++){let n=this.column.templateBudgetSections[i];this.column.formula.length>0?(this.column.formula.push({id:null,value:"+",type:FormulaFieldTypeEnum.Mark}),this.column.formula.push({id:n.sectionID,value:`[ ${n.sectionName} ]`,type:FormulaFieldTypeEnum.Section})):this.column.formula.push({id:n.sectionID,value:`[ ${n.sectionName} ]`,type:FormulaFieldTypeEnum.Section})}},saveTemplate:function(){return this.isSaving=!0,$('[data-toggle="popover"]').popover("hide"),sendAjax("/Start/SaveTemplate",this.template,"POST").then(function(n){n.isOk==!0&&(StartVue.template=n.template,StartVue.errorMessage=null);StartVue.isSaving=!1})},validTemplate:function(){let n=!0;return this.errorMessage=null,this.template.columns.length<2&&(n=!1,this.errorMessage="Шаблон должен содержать хотя бы 2 колонки."),this.template.columns.length>0&&this.template.columns.findIndex(n=>n.templateColumnType==TemplateColumnTypeEnum.BudgetSection&&n.templateBudgetSections.length==0)>-1&&(n=!1,this.errorMessage="Шаблон должен содержать колонки хотя бы с одной категорией."),this.template.columns.length>0&&this.template.columns.findIndex(n=>n.name.length==0)>-1&&(n=!1,this.errorMessage="Название у колонок обязательно."),n},editLimit:function(n){this.periodTypes.length!=0&&(n?this.limit=JSCopyObject(n):(this.limit={id:this.counter++,periodName:"",periodTypeID:-1,isShowOnDashboard:!0},$("#limitSections").val(null).select2(),this.limit.periodTypeID=this.periodTypes[0].id,this.limit.periodName=this.periodTypes[0].name),this.limit.sections?$("#limitSections").val(this.limit.sections.map(n=>n.id)).select2():$("#limitSections").select2(),$("#modal-limit").modal("show"))},saveLimit:function(){this.limit.newSections=$("#limitSections").select2("val").map(function(n){return{id:n}});this.limit.sections=[];for(var t=0;t<this.limit.newSections.length;t++){let n=this.sections.findIndex(n=>n.id==this.limit.newSections[t].id);n!=-1&&this.limit.sections.push(this.sections[n])}if(this.checkLimitForm()==!1)return!1;let n=this.limits.findIndex(n=>n.id==this.limit.id);n==-1?this.limits.push(this.limit):(this.limits[n].name=this.limit.name,this.limits[n].periodTypeID=this.limit.periodTypeID,this.limits[n].periodName=this.limit.periodName,this.limits[n].newSections=this.limit.newSections,this.limits[n].sections=this.limit.sections,this.limits[n].limitMoney=this.limit.limitMoney);$("#modal-limit").modal("hide")},checkLimitForm:function(n){let t=!0;this.limit.newSections.length==0?($("#limitSections").addClass("is-invalid"),$("#limitSections").next().addClass("is-invalid"),t=!1):($("#limitSections").removeClass("is-invalid"),$("#limitSections").next().removeClass("is-invalid"));this.limit.name&&this.limit.name.length>0?$("#limit-name").removeClass("is-invalid"):($("#limit-name").addClass("is-invalid"),t=!1);let i=this.limit.name;return i=i?i.replaceAll(" ",""):"",i.length==0?(t=!1,$("#limit-name").addClass("is-invalid")):$("#limit-name").removeClass("is-invalid"),this.limit.limitMoney&&this.limit.limitMoney>0?$("[name=limitMoney]").removeClass("is-invalid"):(t=!1,$("[name=limitMoney]").addClass("is-invalid")),t==!1&&n&&n.preventDefault(),t},saveLimits:function(){return this.isSaving=!0,sendAjax("/Start/SaveLimits",this.limits,"POST").then(function(n){n.isOk==!0||console.log(n.message);StartVue.isSaving=!1})},removeLimit:function(n){let t=this.limits.findIndex(t=>t.id==n.id);t!=-1&&this.limits.splice(t,1)},editGoal:function(n){n?this.goal=JSCopyObject(n):(this.goal={id:this.counter++},this.goal.dateStart=GetDateByFormat(moment(),"YYYY/MM/DD"),this.goal.isShow_BudgetMonth=!0,this.goal.isShow_BudgetYear=!0);let t=GetFlatpickrRuConfig(this.goal.dateStart);t.onChange=function(n,t){StartVue.flatpickrEnd.config.minDate=t};let i=GetFlatpickrRuConfig(this.goal.dateEnd);i.onChange=function(n,t){StartVue.flatpickrStart.config.maxDate=t};this.flatpickrStart=flatpickr("#date-start",t);this.flatpickrEnd=flatpickr("#date-end",i);$("#modal-goal").modal("show")},getDateByFormat:function(n,t){return GetDateByFormat(n,t)},removeGoal:function(n){let t=this.goals.findIndex(t=>t.id==n.id);t!=-1&&this.goals.splice(t,1)},saveGoal:function(){if(this.checkGoalForm()==!1)return!1;let n=this.goals.findIndex(n=>n.id==this.goal.id);n==-1?this.goals.push(this.goal):(this.goals[n].name=this.goal.name,this.goals[n].dateStart=this.goal.dateStart,this.goals[n].dateEnd=this.goal.dateEnd,this.goals[n].expectationMoney=this.goal.expectationMoney,this.goals[n].isShow_BudgetMonth=this.goal.isShow_BudgetMonth,this.goals[n].isShow_BudgetYear=this.goal.isShow_BudgetYear);$("#modal-goal").modal("hide")},checkGoalForm:function(n){let t=!0;this.goal.name&&this.goal.name.length>0?$("#goal-name").removeClass("is-invalid"):(t=!1,$("#goal-name").addClass("is-invalid"));let i=this.goal.name;return i=i?i.replaceAll(" ",""):"",i.length==0?(t=!1,$("#goal-name").addClass("is-invalid")):$("#goal-name").removeClass("is-invalid"),this.goal.expectationMoney&&this.goal.expectationMoney>0?$("#goal-expectationMoney").removeClass("is-invalid"):(t=!1,$("#goal-expectationMoney").addClass("is-invalid")),t==!1&&n&&n.preventDefault(),t},saveGoals:function(){return this.isSaving=!0,sendAjax("/Start/SaveGoals",this.goals,"POST").then(function(n){n.isOk==!0||console.log(n.message);StartVue.isSaving=!1})}}});