var LimitListVue=new Vue({el:"#limit-list-vue",data:{limits:[],activeLimitPeriodTypeID:-1,limit:{periodName:"",periodTypeID:-1,notifications:[]},msnry:{},sections:[],periodTypes:[],isSaving:!1,numberID:-1,errorMessage:null,currentCount:0,limitCount:0},watch:{},computed:{},mounted:function(){let n=document.getElementById("limit-list-vue");this.currentCount=n.getAttribute("data-current-count")*1;this.limitCount=n.getAttribute("data-limit-count")*1;this.load().then(function(){LimitListVue.loadSections();LimitListVue.loadPeriodTypes()});$("#modal-limit").on("hidden.bs.modal",function(){LimitListVue.closeEditModal()})},methods:{load:function(){return $.ajax({type:"GET",url:"/Limit/GetLimits",contentType:"application/json",dataType:"json",context:this,success:function(n){n.isOk==!0&&(LimitListVue.limits=n.limits,setTimeout(function(){LimitListVue.msnry&&LimitListVue.msnry.destroy!=undefined&&LimitListVue.msnry.destroy();LimitListVue.msnry=new Masonry("#limits",{itemSelector:".masonry-item:not(.d-none)",columnWidth:".masonry-item-sizer",originLeft:!0,horizontalOrder:!0})},100))},error:function(n){console.log(n)}})},loadSections:function(){return sendAjax("/Section/GetAllSectionByPerson",null,"GET").then(function(n){n.isOk==!0&&(LimitListVue.sections=n.sections)})},loadPeriodTypes:function(){return sendAjax("/Limit/GetPeriodTypes",null,"GET").then(function(n){n.isOk==!0&&(LimitListVue.periodTypes=n.periodTypes)})},edit:function(n){this.periodTypes.length!=0&&(n?this.limit=JSCopyObject(n):(this.limit={periodName:"",periodTypeID:-1,isShowOnDashboard:!0,notifications:[]},$("#limitSections").val(null).select2(),this.limit.periodTypeID=this.periodTypes[0].id,this.limit.periodName=this.periodTypes[0].name),this.limit.sections?$("#limitSections").val(this.limit.sections.map(n=>n.id)).select2():$("#limitSections").select2(),setTimeout(function(){$('[data-toggle="tooltip"]').tooltip()},1e3),$("#modal-limit").modal("show"))},saveLimit:function(){return(this.limit.newSections=$("#limitSections").select2("val").map(function(n){return{id:n}}),this.checkForm()==!1)?!1:(this.isSaving=!0,sendAjax("/Limit/Save",this.limit,"POST").then(function(n){if(n.isOk==!0){LimitListVue.currentCount+=1;let t=LimitListVue.limits.findIndex(t=>t.id==n.limit.id);t>=0?LimitListVue.limits[t]=n.limit:(LimitListVue.limits.push(n.limit),setTimeout(function(){LimitListVue.msnry.addItems($("#limit_"+n.limit.id).parent());LimitListVue.msnry.layout()},100));$("#modal-limit").modal("hide")}else console.log(n.message),LimitListVue.errorMessage=n.message;LimitListVue.isSaving=!1}))},checkForm:function(n){let t=!0;this.limit.newSections.length==0?($("#limitSections").addClass("is-invalid"),$("#limitSections").next().addClass("is-invalid"),t=!1):($("#limitSections").removeClass("is-invalid"),$("#limitSections").next().removeClass("is-invalid"));this.limit.name&&this.limit.name.length>0?$("#limit-name").removeClass("is-invalid"):($("#limit-name").addClass("is-invalid"),t=!1);let i=this.limit.name;if(i=i?i.replaceAll(" ",""):"",i.length==0?(t=!1,$("#limit-name").addClass("is-invalid")):$("#limit-name").removeClass("is-invalid"),this.limit.limitMoney&&this.limit.limitMoney>0?$("[name=limitMoney]").removeClass("is-invalid"):(t=!1,$("[name=limitMoney]").addClass("is-invalid")),this.limit.notifications&&this.limit.notifications.length>0)for(var r=0;r<this.limit.notifications.length;r++){let n=this.limit.notifications[r];n.isMail==!1&&n.isSite==!1&&n.isTelegram==!1&&n.isDeleted==!1||n.price*1<=0&&n.isDeleted==!1?($("#errorborder_"+n.id).addClass("border-danger"),$("#texterror_"+n.id).show(),t=!1):($("#errorborder_"+n.id).removeClass("border-danger"),$("#texterror_"+n.id).hide())}return t==!1&&n&&n.preventDefault(),t},closeEditModal:function(){this.limit={periodName:"",periodTypeID:-1,notifications:[]}},remove:function(n){return ShowLoading("#limit_"+n.id),$.ajax({type:"POST",url:"/Limit/Remove",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){n.isDeleted=t.isOk;n.isDeleted&&(LimitListVue.currentCount-=1);HideLoading("#limit_"+n.id)}})},recovery:function(n){return ShowLoading("#limit_"+n.id),$.ajax({type:"POST",url:"/Limit/Recovery",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){n.isDeleted=!t.isOk;n.isDeleted==!1&&(LimitListVue.currentCount+=1);HideLoading("#limit_"+n.id)}})},getDateByFormat:function(n,t){return GetDateByFormat(n,t)},reloadView:function(){setTimeout(function(){LimitListVue.msnry.layout()},100)},toggleLimit:function(n){return ShowLoading("#limit_"+n),$.ajax({type:"GET",url:"/Limit/ToggleLimit?id="+n,contentType:"application/json",dataType:"json",context:n,success:function(n){HideLoading("#limit_"+this);(n.isOk=!0)&&(LimitListVue.limits[LimitListVue.limits.findIndex(n=>n.id==this)].isShowOnDashboard=n.isShow)},error:function(){HideLoading("#limit_"+this)}})},addNotification:function(){this.numberID-=1;this.limit.notifications.push({isSite:!1,isMail:!1,isTelegram:!1,price:this.limit.limitMoney,id:this.numberID,isDeleted:!1});setTimeout(function(){$('[data-toggle="tooltip"]').tooltip();$("#notification-"+LimitListVue.numberID).addClass("show")},500)},removeNotification:function(n){if(n.id<0){let t=this.limit.notifications.findIndex(t=>t.id==n.id);this.limit.notifications.splice(t,1)}else n.isDeleted=!0}}});