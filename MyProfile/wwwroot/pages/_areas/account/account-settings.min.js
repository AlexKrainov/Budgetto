$(function(){$(".account-settings-multiselect").each(function(){$(this).wrap('<div class="position-relative"><\/div>').select2({dropdownParent:$(this).parent()})});$(".account-settings-tagsinput").tagsinput({tagClass:"badge badge-default"})});var AccountSettingsVue=new Vue({el:"#account-settings",data:{user:{userSettings:{},payment:{},imageBase64:null},oldTheme:"",oldEmail:null,newPassword:null,collectiveSearchedUser:{},collectiveUserSearch:"",isFoundCollectiveUser:null,isActiveUsersTab:!0,offerSent:!1,collectiveUsers:[],collectiveRequests:[],offers:[],code:null,isSaving:!1,isValidPassword:!0,isHiddenPassword:!0,isValidCode:!0,isShowCode:!1,isShowSuccessChangedPassword:!1,errorMessage:null},computed:{validName:function(){return this.user.name&&this.user.name.length>=2},validEmail:function(){return this.user.email&&this.user.email.indexOf("@")>0&&this.user.email.indexOf(".")>0},validCollectiveUserSearch:function(){return this.collectiveUserSearch.indexOf("@")>0&&this.collectiveUserSearch.indexOf(".")>0}},watch:{isHiddenPassword:function(n){n?$("input[name=password]").prop("type","password"):$("input[name=password]").prop("type","text")}},mounted:function(){this.loadUser()},methods:{loadUser:function(){return sendAjax("/Identity/Account/LoadUserSettings",null,"GET").then(function(n){AccountSettingsVue.user=n.user;AccountSettingsVue.oldTheme=n.user.userSettings.webSiteTheme;AccountSettingsVue.oldEmail=n.user.email;AccountSettingsVue.refreshCollectiveList();AccountSettingsVue.checkOffers()})},resendConfirmEmail:function(){if(this.validEmail&&this.isSaving==!1)return this.isSaving=!0,sendAjax("/Identity/Account/ResendConfirmEmail",null,"GET").then(function(){AccountSettingsVue.isSaving=!1})},saveUserInfo:function(){if(this.validName&&this.validEmail)return this.isSaving=!0,$.ajax({type:"POST",url:"/Identity/Account/SaveUserInfo",context:this,data:JSON.stringify(this.user),contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){if(n.isOk){$("#userImageLink").prop("src",n.user.imageLink);let t=n.user.email;n.user.name&&(t=n.user.name,n.user.lastName&&(t+=" "+n.user.lastName));$("#userName").text(t);this.user.email!=this.oldEmail&&(this.isShowCode=!0);this.user=n.user;this.oldEmail=n.user.email;toastr.success("Новые данные пользователя сохранены")}else this.errorMessage=n.errorMessage,toastr.error("Новые данные пользователя не сохранены");return this.isSaving=!1,!0},error:function(n,t,i){this.isSaving=!1;console.log(i)}})},encodeImageFileAsURL:function(n){var i=n.target.files[0],t=new FileReader;t.onloadend=function(){AccountSettingsVue.user.imageBase64=t.result};t.readAsDataURL(i)},checkCode:function(){return(this.code&&this.code.length==4)?(this.isValidCode=!0,this.isSaving=!0,$.ajax({type:"GET",url:"/Identity/Account/CheckCodeAfterChangeEmail?code="+this.code,context:this,contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){return n.isOk?(this.code=null,this.isValidCode=!0,this.isShowCode=!1,this.user.isConfirmEmail=!0,toastr.success("Почта подтверждена")):(this.isValidCode=!1,toastr.warning("Неправильный код из письма")),this.isSaving=!1,n},error:function(n,t,i){this.isSaving=!1;console.log(i)}})):(this.isValidCode=!1,!1)},saveNewPassword:function(){if(this.validPassword())return this.isValidPassword=!0,this.isSaving=!0,this.isShowSuccessChangedPassword=!1,sendAjax("/Identity/Account/ChangePassword",this.newPassword,"POST").then(function(n){n.isOk?(AccountSettingsVue.newPassword=null,AccountSettingsVue.isSaving=!1,AccountSettingsVue.isShowSuccessChangedPassword=!0,toastr.success("Пароль обновлен успешно")):toastr.error("Пароль не обновлен")});console.log("not save");this.isValidPassword=!1},validPassword:function(){let n=!0;return this.newPassword==null||this.newPassword==""?(n=!1,this.errorMessage="Пароль не может быть пустым.",n):(this.errorMessage=null,this.newPassword.length<5)?(n=!1,this.errorMessage="Пароль должен содержать не менее 5 символов.",n):(this.errorMessage=null,this.newPassword.indexOf(" ")>=0?(n=!1,this.errorMessage="Пароль не должен содержать пробелов."):this.errorMessage=null,n)},changeStatusCollectiveBudget:function(){return this.user.isAllowCollectiveBudget=!this.user.isAllowCollectiveBudget,sendAjax("/Identity/Account/ChangeStatusCollectiveBudget",this.user.isAllowCollectiveBudget,"POST").then(function(){AccountSettingsVue.refreshCollectiveList().then(function(){AccountSettingsVue.checkOffers()})})},searchUser:function(){return this.isSaving=!0,this.isFoundCollectiveUser=null,sendAjax("/Identity/Account/SearchUser?email="+this.collectiveUserSearch,null,"GET").then(function(n){n.isOk&&(AccountSettingsVue.isSaving=!1,AccountSettingsVue.isFoundCollectiveUser=n.user!=null,AccountSettingsVue.isFoundCollectiveUser&&(AccountSettingsVue.collectiveSearchedUser=n.user))})},sendOffer:function(n){return this.isSaving=!0,sendAjax("/Identity/Account/SendOffer?email="+n,null,"GET").then(function(n){n.isOk&&(AccountSettingsVue.isSaving=!1,AccountSettingsVue.isFoundCollectiveUser=null,AccountSettingsVue.offerSent=!0)})},refreshCollectiveList:function(){return sendAjax("/Identity/Account/RefreshCollectiveList",null,"GET").then(function(n){n.isOk&&(AccountSettingsVue.collectiveUsers=n.collectiveUsers,AccountSettingsVue.collectiveRequests=n.collectiveRequests)})},leftCollectiveBudgetGroup:function(){return sendAjax("/Identity/Account/LeftCollectiveBudgetGroup",null,"GET").then(function(n){n.isOk&&AccountSettingsVue.refreshCollectiveList()})},checkOffers:function(){return sendAjax("/Identity/Account/CheckOffers",null,"GET").then(function(n){n.isOk&&(AccountSettingsVue.offers=n.offers)})},offerAction:function(n,t){return sendAjax("/Identity/Account/OfferAction?offerID="+n+"&action="+t,null,"GET").then(function(n){n.isOk&&(AccountSettingsVue.offers=n.offers,AccountSettingsVue.refreshCollectiveList().then(function(){AccountSettingsVue.checkOffers()}))})},saveUserSettings:function(){return this.isSaving=!0,UserInfo.UserSettings.webSiteTheme=this.user.userSettings.webSiteTheme,UserInfo.UserSettings.mail_News=this.user.userSettings.mail_News,UserInfo.UserSettings.mail_Reminders=this.user.userSettings.mail_Reminders,UserInfo.UserSettings.canUseAlgorithm=this.user.userSettings.canUseAlgorithm,sendAjax("/Identity/Account/SaveUserSettings",this.user.userSettings,"POST").then(function(){AccountSettingsVue.isSaving=!1;AccountSettingsVue.oldTheme!=AccountSettingsVue.user.userSettings.webSiteTheme&&themeSettings.setStyle(AccountSettingsVue.user.userSettings.webSiteTheme);toastr.success("Настройки сохранены")})},generatedRecords:function(){if(confirm("Вы уверены, что хотите сгенерировать данные ?"))return this.isSaving=!0,sendAjax("/Test/GenerateRecords",null,"GET").then(function(){AccountSettingsVue.isSaving=!1})},setFlagConstructor:function(){if(confirm("Вы уверены, что хотите обнулить аккаунт ?"))return this.isSaving=!0,$.ajax({type:"GET",url:"/Test/SetFlagConstructor",context:this,contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){return this.isSaving=!1,n},error:function(n,t,i){this.isSaving=!1;console.log(i)}})},getDateByFormat:function(n,t){return GetDateByFormat(n,t)}}});