var TemplateVue=new Vue({el:"#template-columns",data:{template:{},sections:[],selectedSelections:[],counterNewColumn:-100,counterTemplateBudgetSections:-100,column:{},periodType:-1,isSavingTemplate:!1,errorMessage:null,startColumnsName:"Новая колонка",footerActions:[]},watch:{"template.name":function(){},"template.columns":function(){var i,r,t;this.selectedSelections=[];let n=[];for(i=0;i<this.template.columns.length;i++)for(r=0;r<this.template.columns[i].templateBudgetSections.length;r++)n.push(this.template.columns[i].templateBudgetSections[r].sectionID);for(t=0;t<n.length;t++){let i=this.selectedSelections.filter(i=>i.id==n[t]);i.length==0&&this.selectedSelections.push({id:n[t],count:n.filter(i=>i==n[t]).length})}}},computed:{sectionComponent:function(){return this.$children[0]}},mounted:function(){this.init().then(function(){TemplateVue.loadBAranAndRType();sendAjax("/Common/GetFoolterAction",null,"GET").then(function(n){n.isOk==!0&&(TemplateVue.footerActions=n.data)})})},methods:{init:function(){let n=$("#templateID").val();return sendAjax("/Template/GetTemplate/"+n,null,"GET").then(function(n){n.isOk==!0&&(TemplateVue.template=n.template,$("#templateName").val(n.template.name),TemplateVue.refreshDragNDrop())})},loadBAranAndRType:function(){return sendAjax("/Section/GetAllAreaAndSectionByPerson",null,"GET").then(function(n){n.isOk==!0&&(TemplateVue.sections=n.areas)})},onChooseSection:function(){},refreshDragNDrop:function(){dragula(Array.prototype.slice.call(document.querySelectorAll(".lists")),{moves:function(n,t,i){return i.classList.contains("kanban-box")}}).on("dragend",function(){let t=document.querySelectorAll(".list[columnid]");for(var n=0;n<t.length;n++){let i=t[n].attributes.columnid.value*1;i&&(TemplateVue.template.columns.find(n=>n.id==i).order=n)}$(".list+.ignore-dnd").insertAfter(".lists .list:last")})},addColumn:function(){$("#modalDataTypeColumn").modal("show");this.column={id:this.counterNewColumn++,name:this.startColumnsName,order:this.template.columns.length,isShow:!0,totalAction:0,formula:[],templateBudgetSections:[],placeAfterCommon:0,format:""}},addColumn_Complete:function(){$("#modalDataTypeColumn").modal("hide");this.template.columns.push(this.column);TemplateColumnTypeEnum.BudgetSection==this.column.templateColumnType&&(this.column.totalAction=1,this.addColumnOption_step1(this.column));TemplateColumnTypeEnum.DaysForMonth==this.column.templateColumnType&&(this.column.name="Дни",this.column.format="dd");TemplateColumnTypeEnum.MonthsForYear==this.column.templateColumnType&&(this.column.name="Месяц")},addColumnOption_step1:function(n){this.column=n;$(".selectpicker").selectpicker("destroy").selectpicker("refresh");$("#section-modal").modal("show")},addColumnOption_step2:function(n){this.column.formula.length>0?(this.column.formula.push({id:null,value:"+",type:FormulaFieldTypeEnum.Mark}),this.column.formula.push({id:n.id,value:`[ ${n.name} ]`,type:FormulaFieldTypeEnum.Section})):this.column.formula.push({id:n.id,value:`[ ${n.name} ]`,type:FormulaFieldTypeEnum.Section});this.column.name==this.startColumnsName&&(this.column.name=n.name);this.column.templateBudgetSections.push({id:this.counterTemplateBudgetSections++,sectionID:n.id,sectionName:n.name});let t=this.selectedSelections.findIndex(t=>t.id==n.id);t!=-1?this.selectedSelections[t].count=this.selectedSelections[t].count+1:this.selectedSelections.push({id:n.id,count:1});$("#section-modal").modal("hide")},changeType:function(){this.template.columns=[]},saveTemplate:function(n,t){if(this.validTemplate()==!1)return!1;let i="Save";return n==!0&&(i="SaveAs"),this.isSavingTemplate=!0,this._saveAndGoToView=t,$.ajax({type:"POST",url:"/Template/"+i,context:this,data:JSON.stringify(this.template),contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){return n.isOk==!0?(this.template=n.template,this.errorMessage=null,this._saveAndGoToView&&(window.document.location.href=TemplateGetLinkForView(this.template))):n.nameAlreadyExist&&(this.errorMessage=n.errorMessage),this.isSavingTemplate=!1,!0},error:function(n,t,i){this.isSaving=!1;console.log(i)}})},validTemplate:function(){let n=!0;this.errorMessage=null;let t=this.template.name;return t=t?t.replaceAll(" ",""):"",t.length==0?(n=!1,$("#template-name").addClass("is-invalid")):$("#template-name").removeClass("is-invalid"),this.template.columns.length==0&&(n=!1,this.errorMessage="Шаблон должен содержать хотя бы одну колонку."),this.template.columns.length>0&&this.template.columns.findIndex(n=>n.templateColumnType==TemplateColumnTypeEnum.BudgetSection&&n.templateBudgetSections.length==0)>-1&&(n=!1,this.errorMessage="Шаблон должен содержать колонки хотя бы с одной категорией."),this.template.columns.length>0&&this.template.columns.findIndex(n=>n.name.length==0)>-1&&(n=!1,this.errorMessage="Название у колонок обязательно."),n},saveAndGoToView:function(){this.saveTemplate(!1,!0)},change:function(){},openFormula:function(n){FormulaVue.fields=[];FormData.formula=[];FormulaVue.columnID=n;let t=this.template.columns.findIndex(t=>t.id==n);if(t>=0){for(var i=0;i<this.template.columns[t].templateBudgetSections.length;i++)FormulaVue.fields.push({sectionID:this.template.columns[t].templateBudgetSections[i].sectionID,codeName:this.template.columns[t].templateBudgetSections[i].sectionCodeName,name:this.template.columns[t].templateBudgetSections[i].sectionName});this.template.columns[t].formula&&(FormulaVue.formula=[...this.template.columns[t].formula]);FormulaVue.init()}},setNewFormula:function(n,t){let i=this.template.columns.findIndex(n=>n.id==t);i>=0&&(this.template.columns[i].formula=[...n])},GetDateByFormat:function(n,t){return GetDateByFormat(n,t)},isBudgetSection:function(n){return n==TemplateColumnTypeEnum.BudgetSection},isDaysForMonth:function(n){return n==TemplateColumnTypeEnum.DaysForMonth},isMonthsForYear:function(n){return n==TemplateColumnTypeEnum.MonthsForYear},getFooterActionTypeValue:function(){},removeSectionInColumn:function(n,t,i){let r=this.template.columns[i],e=r.templateBudgetSections[t],u=this.selectedSelections.findIndex(n=>n.id==e.sectionID);u!=-1&&(this.selectedSelections[u].count==1?this.selectedSelections.splice(u,1):this.selectedSelections[u].count=this.selectedSelections[u].count-1);r.templateBudgetSections.splice(t,1);r.formula=[];for(var f=0;f<r.templateBudgetSections.length;f++){let n=r.templateBudgetSections[f];r.formula.length>0?(r.formula.push({id:null,value:"+",type:FormulaFieldTypeEnum.Mark}),r.formula.push({id:n.sectionID,value:`[ ${n.sectionName} ]`,type:FormulaFieldTypeEnum.Section})):r.formula.push({id:n.sectionID,value:`[ ${n.sectionName} ]`,type:FormulaFieldTypeEnum.Section})}}}}),FormulaVue=new Vue({el:"#modal-formula",data:{fields:[],formula:[],isValid:null,el:Object,columnID:null},watch:{},computed:{},mounted:function(){this.el=$("#formula");this.el.tagsinput({allowDuplicates:!0,tagClass:function(n){switch(n.type){case FormulaFieldTypeEnum.Number:return"badge badge-primary";case FormulaFieldTypeEnum.Mark:return"badge badge-success";case FormulaFieldTypeEnum.Parentheses:return"badge badge-success";case FormulaFieldTypeEnum.Section:return"badge badge-default"}},itemValue:"value",itemText:"value",trimValue:!0});this.el.on("beforeItemRemove",function(n){var i=n.item;let t=FormulaVue.formula.findIndex(n=>n==i);t>=0&&FormulaVue.formula.splice(t,1)})},methods:{init:function(){this.refreshFormula();$("#modal-formula").modal("show")},removeLast:function(){this.el.tagsinput("remove",this.formula.pop())},removeAll:function(){this.el.tagsinput("removeAll");this.formula=[]},add:function(n,t){let i={id:null,value:n.target.value,type:t};this.formula.push(i);this.el.tagsinput("add",i)},addField:function(n){let t={id:n.sectionID,value:`[ ${n.name} ]`,type:FormulaFieldTypeEnum.Section};if(this.formula&&this.formula.length>0){let n=this.formula[this.formula.length-1];if(n.type==FormulaFieldTypeEnum.Section||n.type==FormulaFieldTypeEnum.Days){let n={id:null,value:"+",type:FormulaFieldTypeEnum.Mark};this.formula.push(n);this.el.tagsinput("add",n)}}this.formula.push(t);this.el.tagsinput("add",t)},addPeriod:function(n){if(n==FormulaFieldTypeEnum.Days){let t={id:null,value:"[ День ]",type:n};this.formula.push(t);this.el.tagsinput("add",t)}},refreshFormula:function(){this.el.tagsinput("removeAll");for(var n=0;n<this.formula.length;n++)this.el.tagsinput("add",this.formula[n])},save:function(){TemplateVue.setNewFormula(this.formula,this.columnID);$("#modal-formula").modal("hide");this.fields=[];this.formula=[];this.el.tagsinput("removeAll")},isUsing:function(n){return this.formula.findIndex(t=>t.id==n.sectionID)>=0}}});$(function(){dragula(Array.prototype.slice.call(document.querySelectorAll(".kanban-box")));$("html").attr("dir")==="rtl"&&$(".kanban-board-actions .dropdown-menu").removeClass("dropdown-menu-right")});