var ChartEditVue=new Vue({el:"#big-chart-edit-vue",data:{chart:{chartTypeName:"",fields:[],isShowBudgetMonth:!0,isShowBudgetYear:!0},sections:[],fieldsCount:-789,isSaving:!1},watch:{},mounted:function(){let t=$("#big-chart-edit-vue").smartWizard({keyNavigation:!1,autoAdjustHeight:!1,backButtonSupport:!1,useURLhash:!1,showStepURLhash:!1,lang:{next:"Вперед",previous:"Назад"},toolbarSettings:{toolbarPosition:"bottom",toolbarButtonPosition:"center"},keyboardSettings:{keyNavigation:!1}});t.on("leaveStep",function(n,t,i,r){let u=!0;return i==0&&r=="forward"&&(u=ChartEditVue.chart.chartTypeID>0,u==!1?$("#validChooseChartType").show():$("#validChooseChartType").hide()),i==1&&r=="forward"&&(u=ChartEditVue.chart.fields.length>0&&ChartEditVue.validStep1()),u});let n=document.getElementById("big-chart-edit-vue").attributes["data-chart-id"].value;n&&this.loadChart(n);this.loadSections()},methods:{loadChart:function(n){return sendAjax("/Chart/LoadChart?id="+n,null,"GET").then(function(n){ChartEditVue.chart=n.chart;ChartEditVue.selectChart(ChartEditVue.chart.chartTypeID)})},loadSections:function(){return sendAjax("/Section/GetAllSectionByPerson",null,"GET").then(function(n){n.isOk==!0&&(ChartEditVue.sections=n.sections)})},selectChart:function(n){let i=document.querySelectorAll(".chart-list-item");for(var t=0;t<i.length;t++)i[t].attributes["data-chart-type"].value==n?(this.chart.chartTypeID=n,this.chart.chartTypeName=i[t].attributes["data-chart-type-name"].value,i[t].className="chart-list-item active"):i[t].className="chart-list-item";this.chart.id==undefined||this.chart.id<=0?(this.addField(),setTimeout(function(){$("#big-chart-edit-vue").smartWizard("next")},500)):setTimeout(function(){for(var n=0;n<ChartEditVue.chart.fields.length;n++){let t="#field_sections_"+ChartEditVue.chart.fields[n].id;$(t).val(ChartEditVue.chart.fields[n].sections.map(n=>n)).select2({placeholder:"Выбор категорий"});t="#chart_color_"+ChartEditVue.chart.fields[n].id;$(t).colorPick({initialColor:ChartEditVue.chart.fields[n].cssColor,palette:PaletteColorPicker,onColorSelected:function(){let t=this.element[0].id.replace("chart_color_","");var n=ChartEditVue.chart.fields.findIndex(n=>n.id==t);n>=0&&(ChartEditVue.chart.fields[n].cssColor=this.color);this.element.css({backgroundColor:this.color,color:this.color})}})}},10)},addField:function(){this.fieldsCount+=1;this.chart.fields.push({id:this.fieldsCount,name:"",cssColor:""});setTimeout(function(){let n="#field_sections_"+ChartEditVue.fieldsCount;$(n).select2({placeholder:"Продукты, кафе, фастфуд"});n="#chart_color_"+ChartEditVue.fieldsCount;$(n).colorPick({initialColor:GetRandomColor(),palette:PaletteColorPicker,onColorSelected:function(){let t=this.element[0].id.replace("chart_color_","");var n=ChartEditVue.chart.fields.findIndex(n=>n.id==t);n>=0&&(ChartEditVue.chart.fields[n].cssColor=this.color);this.element.css({backgroundColor:this.color,color:this.color})}})},10)},save:function(){if(this.validStep2()==!1)return!1;ShowLoading("#big-chart-edit-vue");this.isSaving=!0;let n=document.getElementById("big-chart-edit-vue").attributes["data-href"].value;n&&n!=""&&(this.chart.href=document.getElementById("big-chart-edit-vue").attributes["data-href"].value);try{return sendAjax("/Chart/Save",this.chart,"POST",this).then(function(n){n.isOk==!0?this.chart=n.chart:console.log(n.message);ChartEditVue.isSaving=!1;HideLoading("#big-chart-edit-vue");document.location.href=n.href})}catch(t){ChartEditVue.isSaving=!1;HideLoading("#big-chart-edit-vue")}},validStep1:function(){let n=!0;for(var t=0;t<this.chart.fields.length;t++){let i=this.chart.fields[t],f="#field_name_"+i.id,e=$(f),r=i.name;r=r?r.replaceAll(" ",""):"";r&&r.length!=0?(e.removeClass("is-invalid"),$("#chart_color_"+i.id).css("margin-top","24px")):(n=!1,e.addClass("is-invalid"),$("#chart_color_"+i.id).css("margin-top","0px"));f="#field_sections_"+i.id;let u=$(f);i.sections=u.val();i.sections&&i.sections.length>0?(u.removeClass("is-invalid"),u.next().find(".select2-selection").removeAttr("style","border-color: #d9534f;")):(n=!1,u.addClass("is-invalid"),u.next().find(".select2-selection").attr("style","border-color: #d9534f;"))}return n},validStep2:function(){let t=!0;this.chart.name&&this.chart.name.length>1?$("#chartName").removeClass("is-invalid"):(t=!1,$("#chartName").addClass("is-invalid"));let n=this.chart.name;return n=n?n.replaceAll(" ",""):"",n.length==0?(t=!1,$("#chartName").addClass("is-invalid")):$("#chartName").removeClass("is-invalid"),t},removeField:function(n){let t=this.chart.fields.findIndex(t=>t.id==n.id);this.chart.fields.splice(t,1)},selectAll:function(n){let t=this.getSelectName(n);$(t+" option").prop("selected",!0);$(t).trigger("change")},unselectAll:function(n){let t=this.getSelectName(n);$(t).val(null).trigger("change")},selectOnlyType:function(n,t){let i=this.getSelectName(n);$(i).val(null);$(i).val(this.sections.filter(n=>n.sectionTypeID==t).map(n=>n.id)).trigger("change")},getSelectName:function(n){return"#field_sections_"+n},getRusName:function(n){return GetRusName(n,["Поле","Поля","Полей"])}}});