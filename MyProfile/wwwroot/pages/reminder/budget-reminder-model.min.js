var ReminderVue=new Vue({el:"#reminder-vue",data:{reminders:[],reminder:{isRepeat:!1,notifications:[]},dateTime:null,dateTimeFinish:null,month:-1,year:-1,flatpickrReminder:{},timezones:[],searchText:null,isSaving:!1,isShowModal:!1,isNew:!0,isPast:!1,numberID:-1},watch:{"reminder.isRepeat":function(){this.reminder.isRepeat&&this.reminder.repeatEvery==undefined&&(this.reminder.repeatEvery="Month")},dateTime:function(n){this.isPast=moment()>moment(n)}},mounted:function(){},methods:{showReminders:function(n){return this.dateTime=n,this.month=null,this.year=null,this.dateTimeFinish=null,this.close(),this.loadTimeLine(n)},showRemindersByPeriod:function(n,t){return this.dateTime=null,this.month=n,this.year=t,this.close(),this.loadTimeLine()},addReminders:function(n){this.dateTime=n;this.timezones.length==0?this.loadTimezone().then(function(){this.edit();this.loadTimeLine(n)}):(this.edit(),this.loadTimeLine(n))},loadTimeLine:function(){return $.ajax({type:"GET",url:"/Reminder/LoadReminders?currentDate="+this.dateTime+"&month="+this.month+"&year="+this.year,contentType:"application/json",dataType:"json",context:this,success:function(n){this.month=null;this.year=null;this.dateTime=n.currentDate;this.dateTimeFinish=n.dateTimeFinish;this.reminders=n.data;$("#modalReminderTimeLine").modal("show");this.loadTimezone()}})},loadTimezone:function(){return this.timezones.length==0?$.ajax({type:"GET",url:"/Common/GetTimeZone",contentType:"application/json",dataType:"json",context:this,success:function(n){this.timezones=n.timezone}}):null},chooseReminderIcon:function(n){if($(".reminder-icons i").removeClass("active"),!n)return!0;let t=n.replace(" ",".");$(".reminder-icons i."+t).addClass("active");this.reminder.cssIcon=n},closeTimeline:function(){this.clearAllStyle()},edit:function(n){if(this.isShowModal=!0,this.reminder={isRepeat:!1,notifications:[]},this.reminder.id=-1,this.reminder.title=null,this.reminder.description=null,this.reminder.cssIcon=null,this.reminder.isRepeat=!1,this.reminder.repeatEvery=null,this.reminder.notifications=[],n){this.isNew=!1;this.reminder=JSCopyObject(n);this.reminder.offSetClient=(new Date).getTimezoneOffset();this.reminder.timeZoneClient=Intl.DateTimeFormat().resolvedOptions().timeZone;let t=GetFlatpickrRuConfigWithTime(this.reminder.dateReminder);flatpickr("#reminderDateReminder",t);setTimeout(function(){for(var n=0;n<ReminderVue.reminder.notifications.length;n++)moment(ReminderVue.reminder.notifications[n].expirationDateTime)<moment()?flatpickr("#expirationDateTime_"+ReminderVue.reminder.notifications[n].id,GetFlatpickrRuConfigWithTime(ReminderVue.reminder.notifications[n].expirationDateTime)):flatpickr("#expirationDateTime_"+ReminderVue.reminder.notifications[n].id,GetFlatpickrRuConfigWithTime(ReminderVue.reminder.notifications[n].expirationDateTime),new Date)},1e3)}else{this.isNew=!0;this.dateTime=this.dateTime.replace("T00","T"+(new Date).getHours());this.reminder.dateReminder=this.dateTime;this.reminder.offSetClient=(new Date).getTimezoneOffset();this.reminder.timeZoneClient=Intl.DateTimeFormat().resolvedOptions().timeZone;this.reminder.olzonTZID=this.getTimeZoneID(this.reminder.timeZoneClient);let n=GetFlatpickrRuConfigWithTime(this.dateTime);n.onChange=this.onChangeDateTime;flatpickr("#reminderDateReminder",n)}this.chooseReminderIcon(this.reminder.cssIcon)},getTimeZoneID:function(n){let t=this.timezones.findIndex(t=>t.olzonTZName==n);return t!=-1?this.timezones[t].olzonTZID:(t=this.timezones.findIndex(n=>n.olzonTZName=="Europe/Moscow"),this.timezones[t].olzonTZID)},close:function(){this.isShowModal=!1;this.reminder={isRepeat:!1};this.chooseReminderIcon()},save:function(){return this.checkValid()==!1?!1:(this.isSaving=!0,$.ajax({type:"POST",url:"/Reminder/Edit",data:JSON.stringify(this.reminder),context:this,contentType:"application/json",dataType:"json",success:function(n){if(n.isOk){if(this.reminder.id>0){let t=this.reminders.findIndex(t=>t.id==n.data.id);this.reminders[t]=n.data}else this.reminders.push(n.data);BudgetVue.refresh("onlyTable");BudgetVue.refresh("only-progress");this.close()}this.isSaving=!1},error:function(n){console.log(n);this.isSaving=!1}}))},checkValid:function(){let n=!0;$("#reminderTitle, #reminderDateReminder").removeClass("is-invalid");this.reminder.title&&this.reminder.title.length>0||(n=!1,$("#reminderTitle").addClass("is-invalid"));let t=this.reminder.title;if(t=t?t.replaceAll(" ",""):"",t.length==0?(n=!1,$("#reminderTitle").addClass("is-invalid")):$("#reminderTitle").removeClass("is-invalid"),this.reminder.cssIcon&&this.reminder.cssIcon.length>0?$("#reminderIcons").css("display","none"):(n=!1,$("#reminderIcons").css("display","block")),this.reminder.dateReminder&&this.reminder.dateReminder.length>0||(n=!1,$("#reminderDateReminder").addClass("is-invalid")),this.reminder.isRepeat&&this.reminder.repeatEvery==null?($("#repeatType").addClass("is-invalid"),n=!1):$("#repeatType").removeClass("is-invalid"),this.reminder.notifications&&this.reminder.notifications.length>0)for(var i=0;i<this.reminder.notifications.length;i++){let t=this.reminder.notifications[i];(t.isMail!=!1||t.isSite!=!1||t.isTelegram!=!1||t.isDeleted!=!1)&&(t.expirationDateTime||t.isDeleted!=!1)?($("#errorborder_"+t.id).removeClass("border-danger"),$("#texterror_"+t.id).hide()):($("#errorborder_"+t.id).addClass("border-danger"),$("#texterror_"+t.id).show(),n=!1)}return n},remove:function(n){if(n.isWasRepeat&&n.isRepeat==!1){toastr.warning("Внимание! Если вы удалите это напоминание, удалится вся цепочка напоминаний.");n.isWasRepeat=!1;return}return ShowLoading("#reminder_"+n.id),$.ajax({type:"POST",url:"/Reminder/Remove",data:JSON.stringify(n),context:this,contentType:"application/json",dataType:"json",success:function(t){let i=this.reminders.findIndex(n=>n.id==t.data.id);this.reminders[i].isDeleted=t.isDeleted;this.reminder.id==n.id&&this.close();HideLoading("#reminder_"+n.id);BudgetVue.refresh("onlyTable")}})},recovery:function(n){return ShowLoading("#reminder_"+n.id),$.ajax({type:"POST",url:"/Reminder/Recovery",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){let i=this.reminders.findIndex(n=>n.id==t.data.id);this.reminders[i].isDeleted=!t.isRecovery;HideLoading("#reminder_"+n.id);BudgetVue.refresh("onlyTable")}})},GetDateByFormat:function(n,t){return GetDateByFormat(n,t)},addNotification:function(){this.numberID-=1;this.reminder.notifications.push({isSite:!1,isMail:!1,isTelegram:!1,expirationDateTime:this.reminder.dateReminder,id:this.numberID,isDeleted:!1,isRepeat:this.reminder.isRepeat,repeatMinutes:0});setTimeout(function(){let n=ReminderVue.reminder.notifications.findIndex(n=>n.id==ReminderVue.numberID),t=GetFlatpickrRuConfigWithTime(ReminderVue.reminder.notifications[n].expirationDateTime,new Date);t.onChange=function(n,t,i){let r=moment.duration(moment(t).diff(moment(ReminderVue.reminder.dateReminder))),u=i.element.id.replace("expirationDateTime_","")*1,f=ReminderVue.reminder.notifications.findIndex(n=>n.id==u);ReminderVue.reminder.notifications[f].repeatMinutes=Math.round(r.asMinutes()*-10)/10};flatpickr("#expirationDateTime_"+ReminderVue.reminder.notifications[n].id,t);$('[data-toggle="tooltip"]').tooltip();$("#notification-"+ReminderVue.reminder.notifications[n].id).addClass("show")},300)},removeNotification:function(n){if(n.id<0){let t=this.reminder.notifications.findIndex(t=>t.id==n.id);this.reminder.notifications.splice(t,1)}else n.isDeleted=!0}}});