var MainAccountVue=new Vue({el:"#main-account-modal-vue",data:{account:{id:undefined,currentyID:1,bankTypeID:-1,isDeleted:!1,isCash:!1},bankTypes:[],banks:[],currencyInfos:Metadata.currencies,isSaving:!1},watch:{"account.bankTypeID":function(n){n!=undefined&&(this.banks=this.bankTypes.filter(t=>t.id==n)[0].banks)}},mounted:function(){setTimeout(function(){$.ajax({type:"GET",url:"/Account/GetEnvironmentForMain",contentType:"application/json; charset=utf-8",dataType:"json",context:MainAccountVue,success:function(n){return n.isOk&&(this.bankTypes=n.bankTypes),n},error:function(n,t,i){console.log(i)}})},1e3)},methods:{edit:function(n,t){n?(this.account=n,this.account.isCash=n.accountType==1):this.account={id:undefined,currentyID:1,name:undefined,bankTypeID:1,isDeleted:!1,isCash:t};setTimeout(function(){$("#main-account-bank").trigger("change").val(MainAccountVue.account.bankID).select2({dropdownCssClass:"d-block",selectionCssClass:"d-block"})},300);$("#main-account-name").removeClass("is-invalid");$("#modal-main-account").modal("show")},showHide:function(n,t){this.account=n;let i="#account_"+n.id;return ShowLoading(i),$(i).find(".dropdown-menu").removeClass("show"),$.ajax({type:"POST",url:"/Account/ShowHide",contentType:"application/json; charset=utf-8",data:JSON.stringify(this.account),dataType:"json",context:this,success:function(n){if(HideLoading(i),n.isOk)if(this.account.isHide=t,typeof BudgetVue=="object"&&t){let n=BudgetVue.accounts.findIndex(n=>n.id==this.account.id);BudgetVue.accounts.splice(n,1);BudgetVue.accounts.push(this.account)}else{let n=BudgetVue.accounts.filter(n=>n.isHide),t=BudgetVue.accounts.filter(n=>n.isHide==!1);BudgetVue.accounts=t.concat(n)}return $('[data-toggle="tooltip"]').tooltip(),n},error:function(n,t,i){console.log(i)}})},save:function(){this.checkForm()!=!1&&(this.isSaving=!0,this.account.balance||(this.account.balance=0),$.ajax({type:"POST",url:"/Account/Save",contentType:"application/json; charset=utf-8",data:JSON.stringify(this.account),dataType:"json",context:this,success:function(n){return n.isOk&&(typeof BudgetVue=="object"&&BudgetVue.refresh("onlySummery"),typeof RecordVue=="object"&&RecordVue.recordComponent.loadAccounts(),$("#modal-main-account").modal("hide")),this.isSaving=!1,n},error:function(n,t,i){this.isSaving=!1;console.log(i)}}))},checkForm:function(n){let t=!0;return this.account.name&&this.account.name.length>0?$("#main-account-name").removeClass("is-invalid"):(t=!1,$("#main-account-name").addClass("is-invalid")),this.account.isCash==!1&&(this.account.bankID=$("#main-account-bank").val()*1,this.account.bankID&&this.account.bankID>0?$("#main-account-bank").removeClass("is-invalid"):(t=!1,$("#main-account-bank").addClass("is-invalid"))),t==!1&&n&&n.preventDefault(),t},removeOrRecovery:function(n){let t="#main_account_"+n.id;ShowLoading(t);$(t).find(".dropdown-menu").removeClass("show");this.account=n;this.account.isDeleted=!this.account.isDeleted;$.ajax({type:"POST",url:"/Account/RemoveOrRecovery",contentType:"application/json; charset=utf-8",data:JSON.stringify(this.account),dataType:"json",context:this,success:function(n){if(n.isOk){if(!this.account.isDeleted==n.isDeleted){this.account.isDeleted?toastr.error("Ошибка во время удаления."):toastr.error("Ошибка во время восстановления.");this.account.isDeleted=!this.account.isDeleted;HideLoading("#main_account_"+this.account.id);return}this.account.isDeleted=n.isDeleted;this.account.accountType==1?this.account.isDeleted?toastr.success("Вы успешно наличные"):toastr.success("Вы успешно восстановили наличные"):this.account.isDeleted?toastr.success("Вы успешно удалили организацию"):toastr.success("Вы успешно восстановили организацию")}return HideLoading("#main_account_"+this.account.id),n},error:function(n,t,i){toastr.error("Ошибка во время удаления");console.log(i)}})},showHide:function(n,t){AccountVue.showHide(JSCopyObject(n),t)}}}),AccountVue=new Vue({el:"#account-modal-vue",data:{account:{id:undefined,accountType:1,currency:{},currencyID:-1,balance:0,cachBackBalance:0,cashBackForAllPercent:1,isCountTheBalance:!0,isCountBalanceInMainAccount:!0,isDeleted:!1,paymentSystemID:null},bankTypes:[],accountTypes:[],paymentSystems:[],currencyInfos:Metadata.currencies,isSaving:!1,showAttention:!1},watch:{"account.cachBackBalance":function(n){n||(this.account.cachBackBalance=0)},"account.bankTypeID":function(n){console.log(n);n!=undefined||n!=null?this.accountTypes=this.bankTypes.filter(t=>t.id==n)[0].accountTypes:n==null&&(this.accountTypes=[{accountType:1,icon:"pe-7s-cash",banks:null,name:"Наличные",id:1}])}},mounted:function(){setTimeout(function(){$.ajax({type:"GET",url:"/Account/GetEnvironment",contentType:"application/json; charset=utf-8",dataType:"json",context:AccountVue,success:function(n){return n.isOk&&(this.bankTypes=n.bankTypes,this.paymentSystems=n.paymentSystems),n},error:function(n,t,i){console.log(i)}})},1e3)},methods:{edit:function(n,t){if(n?this.account=n:(this.account={id:undefined,parentID:t.id,accountType:t.accountType,accountIcon:t.accountIcon,bankID:t.bankID,bankLogo:t.bankLogo,bankTypeID:t.bankTypeID,bankName:t.bankName,paymentSystemID:null,currency:{},currencyID:-1,balance:null,cachBackBalance:0,cashBackForAllPercent:1,isCountTheBalance:!0,isCountBalanceInMainAccount:!0,isDeleted:!1,isCash:t.accountType==1},this.account.currencyID=UserInfo.Currency.ID,this.account.currency=this.currencyInfos[this.currencyInfos.findIndex(n=>n.id==this.account.currencyID)]),this.account.accountType==2){let n=GetFlatpickrRuConfig_Month(this.account.expirationDate);this.flatpickrExpirationDate=flatpickr("#expirationDate",n)}else if(this.account.accountType==8||this.account.accountType==6){let n=GetFlatpickrRuConfig(this.account.dateStart);flatpickr("#account-date-start",n);n=GetFlatpickrRuConfig(this.account.expirationDate);flatpickr("#expirationDate",n)}$("#account-name").removeClass("is-invalid");$("#modal-account").modal("show")},showHide:function(n,t){this.account=n;let i="#account_"+n.id;return ShowLoading(i),$(i).find(".dropdown-menu").removeClass("show"),$.ajax({type:"GET",url:"/Account/Toggle?accountID="+this.account.id,contentType:"application/json; charset=utf-8",dataType:"json",context:this,success:function(n){if(HideLoading(i),n.isOk&&(this.account.isHide=t,typeof BudgetVue=="object"))for(var r=0;r<BudgetVue.accounts.length;r++)if(this.account.parentID==null){if(BudgetVue.accounts[r].id==this.account.id){BudgetVue.accounts[r].isHideCurrentAccount=t;break}}else{let n=BudgetVue.accounts[r].accounts.findIndex(n=>n.id==this.account.id);if(n>=0){BudgetVue.accounts[r].accounts[n].isHideCurrentAccount=t;break}}return $('[data-toggle="tooltip"]').tooltip(),n},error:function(n,t,i){console.log(i)}})},save:function(){this.checkForm()!=!1&&(this.isSaving=!0,this.account.balance||(this.account.balance=0),$.ajax({type:"POST",url:"/Account/Save",contentType:"application/json; charset=utf-8",data:JSON.stringify(this.account),dataType:"json",context:this,success:function(n){return n.isOk&&(typeof BudgetVue=="object"&&BudgetVue.refresh("onlySummery"),typeof RecordVue=="object"&&RecordVue.recordComponent.loadAccounts(),$("#modal-account").modal("hide")),this.isSaving=!1,n},error:function(n,t,i){this.isSaving=!1;console.log(i)}}))},checkForm:function(n){let t=!0;return this.account.name&&this.account.name.length>0?$("#account-name").removeClass("is-invalid"):(t=!1,$("#account-name").addClass("is-invalid")),t==!1&&n&&n.preventDefault(),t},removeOrRecovery:function(n){if(typeof BudgetVue=="object"&&this.account.isDeleted==!1){let n=BudgetVue.accounts.filter(n=>n.isDeleted==!1).length;if(n<=1){toastr.error("Нельзя удалить все счета, должен оставаться хотя бы один.");return}}let t="#account_"+n.id;ShowLoading(t);$(t).find(".dropdown-menu").removeClass("show");this.account=n;this.account.isDeleted=!this.account.isDeleted;$.ajax({type:"POST",url:"/Account/RemoveOrRecovery",contentType:"application/json; charset=utf-8",data:JSON.stringify(this.account),dataType:"json",context:this,success:function(n){if(n.isOk){if(!this.account.isDeleted==n.isDeleted){this.account.isDeleted?toastr.error("Ошибка во время удаления счета. Возможно, вы удаляете последний счет."):toastr.error("Ошибка во время восстановления счета.");this.account.isDeleted=!this.account.isDeleted;HideLoading("#account_"+this.account.id);return}if(this.account.isDeleted=n.isDeleted,this.account.isDefault=!1,typeof BudgetVue=="object"){let t=BudgetVue.accounts.findIndex(t=>t.id==n.accountIDWithIsDefault);t!=-1&&n.accountIDWithIsDefault!=-1&&(BudgetVue.accounts[t].isDefault=!0);BudgetVue.loadSummaries()}typeof RecordVue=="object"&&RecordVue.recordComponent.loadAccounts();this.account.isDeleted?toastr.success("Вы успешно удалили счет"):toastr.success("Вы успешно восстановили счет")}return HideLoading("#account_"+this.account.id),n},error:function(n,t,i){toastr.error("Ошибка во время удаления счета");console.log(i)}})},changeCurrency:function(n){this.account.currencyID=n.id;this.account.currency=n;this.$forceUpdate()},setExpirationDate:function(n){if(this.account.dateStart){let t=moment();t=this.account.dateStart.length<=10?moment(this.account.dateStart,"YYYY/MM/DD"):moment(this.account.dateStart);this.account.expirationDate=t.add(n,"year").format();dateConfig=GetFlatpickrRuConfig(this.account.expirationDate);flatpickr("#expirationDate",dateConfig)}}}}),AccountTransferVue=new Vue({el:"#account-transfer-modal-vue",data:{accountsFrom:[],accountsTo:[],accountFrom:{currencyID:1},accountTo:{currencyID:1},value:null,currencyValue:1,endValue:null,newValueFrom:null,newValueTo:null,comment:null,showEmpty:!1,currencyInfos:Metadata.currencies,isSaving:!1},watch:{value:function(){this.refreshValue()},accountFrom:function(n){var t;for(this.accountTo={},t=0;t<this.accountsTo.length;t++)this.accountsTo[t].isSelected=!1,this.accountsTo[t].isDisabled=this.accountsTo[t].id==n.id;for(this.showEmpty=this.accountsTo.filter(n=>n.isDisabled).length==this.accountsTo.length,t=0;t<this.accountsTo.length;t++)if(this.accountsTo[t].isDisabled==!1){this.accountsTo[t].isSelected=!0;this.accountTo=this.accountsTo[t];break}this.refreshValue()},accountTo:function(){this.refreshValue()},currencyValue:function(){this.refreshValue()}},computed:{},mounted:function(){},methods:{transferMoney:function(n,t){this.newValueFrom=null;this.newValueTo=null;this.value=null;this.accountsFrom=JSCopyArray(n.filter(n=>n.isDeleted==!1));this.accountsTo=JSCopyArray(n.filter(n=>n.isDeleted==!1));let i=this.accountsFrom.findIndex(n=>n.id==t);this.accountFrom=this.accountsFrom[i];$("#modal-account-transfer").modal("show")},getCurrencyValue:function(n,t){return n.currency?new Intl.NumberFormat(n.currency.specificCulture,{style:"currency",currency:n.currency.codeName}).format(t):null},refreshValue:function(){this.endValue=this.accountFrom.currencyID!=this.accountTo.currencyID?this.getValueWithCurrency():this.value*1;this.value>0?(this.newValueFrom=this.accountFrom.balance-this.value,this.newValueTo=this.accountTo.balance+this.endValue):this.value<0&&(this.value=0)},getValueWithCurrency:function(){return this.accountFrom.currency.codeName=="RUB"?this.value/(this.currencyValue*1):this.value*this.currencyValue*1},save:function(){this.isSaving=!0;$.ajax({type:"POST",url:"/Account/TransferMoney",contentType:"application/json; charset=utf-8",data:JSON.stringify({accountFromID:this.accountFrom.id,accountToID:this.accountTo.id,value:this.value,comment:this.comment,endValue:this.endValue,currencyValue:this.currencyValue}),dataType:"json",context:this,success:function(n){return n.isOk&&(toastr.success("Деньги переведены"),typeof BudgetVue=="object"&&BudgetVue.refresh("onlySummery"),$("#modal-account-transfer").modal("hide")),this.isSaving=!1,n},error:function(n,t,i){this.isSaving=!1;console.log(i)}})}}});