var AccountVue=new Vue({el:"#account-modal-vue",data:{account:{id:undefined,accountType:1,currency:{},currencyID:-1,balance:0,cachBackBalance:0,cashBackForAllPercent:1,isDeleted:!1},accountTypes:[],banks:[],flatpickrExpirationDate:null,currencyInfos:Metadata.currencies,isSaving:!1},watch:{},mounted:function(){$.ajax({type:"GET",url:"/Account/GetEnvironment",contentType:"application/json; charset=utf-8",dataType:"json",context:this,success:function(n){return n.isOk&&(this.accountTypes=n.accountTypes,this.banks=n.banks),n},error:function(n,t,i){console.log(i)}})},methods:{edit:function(n){n?this.account=n:(this.account={id:undefined,accountType:1,currency:{},currencyID:-1,balance:0,cachBackBalance:0,cashBackForAllPercent:1,isDeleted:!1},this.account.currencyID=UserInfo.Currency.ID,this.account.currency=this.currencyInfos[this.currencyInfos.findIndex(n=>n.id==this.account.currencyID)]);let t=GetFlatpickrRuConfig_Month(this.account.expirationDate);this.flatpickrExpirationDate=flatpickr("#expirationDate",t);$("#account-name").removeClass("is-invalid");$("#modal-account").modal("show")},showHide:function(n,t){this.account=n;let i="#account_"+n.id;return ShowLoading(i),$(i).find(".dropdown-menu").removeClass("show"),$.ajax({type:"POST",url:"/Account/ShowHide",contentType:"application/json; charset=utf-8",data:JSON.stringify(this.account),dataType:"json",context:this,success:function(n){if(HideLoading(i),n.isOk)if(this.account.isHide=t,typeof BudgetVue=="object"&&t){let n=BudgetVue.accounts.findIndex(n=>n.id==this.account.id);BudgetVue.accounts.splice(n,1);BudgetVue.accounts.push(this.account)}else{let n=BudgetVue.accounts.filter(n=>n.isHide),t=BudgetVue.accounts.filter(n=>n.isHide==!1);BudgetVue.accounts=t.concat(n)}return $('[data-toggle="tooltip"]').tooltip(),n},error:function(n,t,i){console.log(i)}})},save:function(){this.checkForm()!=!1&&(this.isSaving=!0,$.ajax({type:"POST",url:"/Account/Save",contentType:"application/json; charset=utf-8",data:JSON.stringify(this.account),dataType:"json",context:this,success:function(n){return n.isOk&&(typeof BudgetVue=="object"&&BudgetVue.refresh("onlySummery"),typeof RecordVue=="object"&&RecordVue.recordComponent.loadAccounts(),$("#modal-account").modal("hide")),this.isSaving=!1,n},error:function(n,t,i){this.isSaving=!1;console.log(i)}}))},checkForm:function(n){let t=!0;return this.account.name&&this.account.name.length>0?$("#account-name").removeClass("is-invalid"):(t=!1,$("#account-name").addClass("is-invalid")),t==!1&&n&&n.preventDefault(),t},removeOrRecovery:function(n){if(typeof BudgetVue=="object"&&this.account.isDeleted==!1){let n=BudgetVue.accounts.filter(n=>n.isDeleted==!1).length;if(n<=1){toastr.error("Нельзя удалить все счета, должен оставаться хотя бы один.");return}}let t="#account_"+n.id;ShowLoading(t);$(t).find(".dropdown-menu").removeClass("show");this.account=n;this.account.isDeleted=!this.account.isDeleted;$.ajax({type:"POST",url:"/Account/RemoveOrRecovery",contentType:"application/json; charset=utf-8",data:JSON.stringify(this.account),dataType:"json",context:this,success:function(n){if(n.isOk){if(!this.account.isDeleted==n.isDeleted){this.account.isDeleted?toastr.error("Ошибка во время удаления счета. Возможно, вы удаляете последний счет."):toastr.error("Ошибка во время восстановления счета.");this.account.isDeleted=!this.account.isDeleted;HideLoading("#account_"+this.account.id);return}if(this.account.isDeleted=n.isDeleted,this.account.isDefault=!1,typeof BudgetVue=="object"){let t=BudgetVue.accounts.findIndex(t=>t.id==n.accountIDWithIsDefault);t!=-1&&n.accountIDWithIsDefault!=-1&&(BudgetVue.accounts[t].isDefault=!0);BudgetVue.loadSummaries()}typeof RecordVue=="object"&&RecordVue.recordComponent.loadAccounts();this.account.isDeleted?toastr.success("Вы успешно удалили счет"):toastr.success("Вы успешно восстановили счет")}return HideLoading("#account_"+this.account.id),n},error:function(n,t,i){toastr.error("Ошибка во время удаления счета");console.log(i)}})},changeCurrency:function(n){this.account.currencyID=n.id;this.account.currency=n;this.$forceUpdate()}}}),AccountTransferVue=new Vue({el:"#account-transfer-modal-vue",data:{accountsFrom:[],accountsTo:[],accountFrom:{},accountTo:{},value:null,newValueFrom:null,newValueTo:null,showEmpty:!1,currencyInfos:Metadata.currencies,isSaving:!1},watch:{value:function(n){n>0?(this.newValueFrom=this.accountFrom.balance-n*1,this.newValueTo=this.accountTo.balance+n*1):(this.newValueFrom=null,this.newValueTo=null)},accountFrom:function(n){let r=n.currencyID;this.accountTo={};for(var t=0;t<this.accountsTo.length;t++)this.accountsTo[t].isDisabled=this.accountsTo[t].currencyID!=r||this.accountsTo[t].id==n.id,this.accountsTo[t].isSelected=!1;this.showEmpty=this.accountsTo.filter(n=>n.isDisabled).length==this.accountsTo.length;let i=this.accountsTo.filter(n=>n.currencyID==r);if(i.length>=2){let t=i.findIndex(t=>t.id!=n.id);this.accountTo=i[t];i[t].isSelected=!0}},accountTo:function(){}},computed:{},mounted:function(){},methods:{transferMoney:function(n,t){this.accountsFrom=JSCopyArray(n);this.accountsTo=JSCopyArray(n);let i=this.accountsFrom.findIndex(n=>n.id==t);this.accountFrom=this.accountsFrom[i];$("#modal-account-transfer").modal("show")},getCurrencyValue:function(n){return this.accountFrom.currency?new Intl.NumberFormat(this.accountFrom.currency.specificCulture,{style:"currency",currency:this.accountFrom.currency.codeName}).format(n):null},save:function(){this.isSaving=!0;$.ajax({type:"POST",url:"/Account/TransferMoney",contentType:"application/json; charset=utf-8",data:JSON.stringify({accountFromID:this.accountFrom.id,accountToID:this.accountTo.id,value:this.value}),dataType:"json",context:this,success:function(n){return n.isOk&&(toastr.success("Деньги переведены"),typeof BudgetVue=="object"&&BudgetVue.refresh("onlySummery"),$("#modal-account-transfer").modal("hide")),this.isSaving=!1,n},error:function(n,t,i){this.isSaving=!1;console.log(i)}})}}});