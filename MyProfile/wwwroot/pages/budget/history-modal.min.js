var HistoryVue=new Vue({el:"#history-vue",data:{records:[],spendingTotalMoney:0,spendingErningMoney:0,spendingInvestingMoney:0,dateTime:null,filter:{isSection:!0,Count:0,isAmount:!0,isConsiderCollection:!1,isCount:!1,Year:moment().get("year"),sections:[],tags:[],startDate:null,endDate:null},searchText:null,sections:[],userTags:[],flatpickrStart:null,flatpickrEnd:null},watch:{searchText:function(n){n&&(n=n.toLocaleLowerCase());for(var t=0;t<this.records.length;t++){let i=this.records[t];i.isShowForFilter=i.sectionName.toLocaleLowerCase().indexOf(n)>=0||i.description&&i.description.toLocaleLowerCase().indexOf(n)>=0||i.areaName.toLocaleLowerCase().indexOf(n)>=0||i.userName&&i.userName.toLocaleLowerCase().indexOf(n)>=0||i.money.toString().indexOf(n)>=0||i.rawData.indexOf(n)>=0}},records:{handler:function(){this.spendingTotalMoney=0;this.spendingErningMoney=0;this.spendingInvestingMoney=0;for(var n=0;n<this.records.length;n++)this.records[n].isDeleted==!1&&(this.records[n].sectionTypeID==1?this.spendingErningMoney+=this.records[n].money*1:this.records[n].sectionTypeID==2?this.spendingTotalMoney+=this.records[n].money*1:this.records[n].sectionTypeID==3&&(this.spendingInvestingMoney+=this.records[n].money*1))},deep:!0}},mounted:function(){setTimeout(function(){HistoryVue.sections=JSCopyArray(RecordVue.recordComponent.sectionComponent.sections);HistoryVue.userTags=JSCopyArray(RecordVue.recordComponent.userTags);HistoryVue.tagify=new Tagify(document.querySelector('input[name="tags"]'),{whitelist:HistoryVue.userTags,enforceWhitelist:!0,delimiters:null,dropdown:{maxItems:20,classname:"tags-look",enabled:0,closeOnSelect:!1},callbacks:{add:HistoryVue.addTag,remove:HistoryVue.removeTag}});setTimeout(HistoryVue.unselectAllTags,100);HistoryVue.sections.length==0&&setTimeout(function(){HistoryVue.sections=JSCopyArray(RecordVue.recordComponent.sectionComponent.sections)},8e3)},3e3);$("#modalTimeLine").on("hide.bs.modal",function(){$("#historyCollapse").removeClass("show")})},methods:{showHistory:function(n,t){var i,r;for(this.dateTime=t,this.unselectAll(),i=0;i<this.sections.length;i++)this.sections[i].isSelected=n.sections.some(n=>n==this.sections[i].id);this.filter.startDate=n.startDate;this.filter.endDate=n.endDate;let u=GetFlatpickrRuConfig(moment(this.filter.startDate,"YYYY/MM/DD").toDate());this.flatpickrStart=flatpickr("#dateHistoryStart",u);r=GetFlatpickrRuConfig(moment(this.filter.endDate,"YYYY/MM/DD").toDate());this.flatpickrEnd=flatpickr("#dateHistoryEnd",r);this.search()},showLastHistory:function(){this.search()},search:function(){return this.filter.sections=this.sections.filter(n=>n.isSelected).map(n=>n.id),this.filter.tags=this.userTags.filter(n=>n.isShow==!1).map(n=>n.id),this.filter.startDate=moment(this.flatpickrStart.latestSelectedDateObj).format(),this.filter.endDate=moment(this.flatpickrEnd.latestSelectedDateObj).format(),this.loadTimeLine()},loadTimeLine:function(){return ShowLoading(".records-timeline"),$("#modalTimeLine").modal("show"),$.ajax({type:"POST",url:"/Budget/LoadingRecordsForTableView",data:JSON.stringify(this.filter),contentType:"application/json",dataType:"json",context:this,success:function(n){this.records=n.data;HideLoading(".records-timeline")}})},selectAll:function(){for(var n=0;n<this.sections.length;n++)this.sections[n].isSelected=!0},unselectAll:function(){for(var n=0;n<this.sections.length;n++)this.sections[n].isSelected=!1},selectOnlyType:function(n){for(var t=0;t<this.sections.length;t++)this.sections[t].isSelected=this.sections[t].sectionTypeID==n},selectAllTags:function(){this.userTags=this.userTags.map(function(n){return n.isShow=!1,n});this.tagify.addTags(this.userTags)},unselectAllTags:function(){this.tagify.removeAllTags();for(var n=0;n<this.userTags.length;n++)this.userTags[n].isShow=!0},selectedTag:function(n){this.tagify.addTags([n]);n.isShow=!1},addTag:function(n){let t=n.detail.data;if(t.isShow){let n=this.userTags.findIndex(n=>n.id==t.id);n!=-1&&(this.userTags[n].isShow=!1)}},removeTag:function(n){if(n.detail.data&&n.detail.data.id){let t=this.userTags.findIndex(t=>t.id==n.detail.data.id);t>=0&&(this.userTags[t].isShow=!0)}},onChooseSection:function(){},closeTimeline:function(){this.clearAllStyle()},getCurrencyValue:function(n){let t=new Intl.NumberFormat(UserInfo.Currency.SpecificCulture,{style:"currency",currency:UserInfo.Currency.CodeName}).format(n.money);if(UserInfo.Currency.ID!=n.currencyID)try{t+=" ("+new Intl.NumberFormat(n.currencySpecificCulture,{style:"currency",currency:n.currencyCodeName}).format(CalculateExpression(n.tag))+")"}catch(i){}return t},descriptionBuilder:function(n){return TagBuilder.toDescription(n)},GetDateByFormat:function(n,t){return GetDateByFormat(n,t)},add:function(){$("#modalTimeLine").modal("hide");setTimeout(RecordVue.showModal,750,this.dateTime,"BudgetVue.refreshAfterChangeRecords")},edit:function(n){$("#modalTimeLine").modal("hide");setTimeout(RecordVue.editByElement,750,n,[BudgetVue.refreshAfterChangeRecords,HistoryVue.showLastHistory])},remove:function(n){return ShowLoading("#record_"+n.id),$.ajax({type:"POST",url:"/Budget/RemoveRecord",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){n.isDeleted=t.isOk;HideLoading("#record_"+n.id);BudgetVue.refreshAfterChangeRecords(t.dateTimeOfPayment)}})},recovery:function(n){return ShowLoading("#record_"+n.id),$.ajax({type:"POST",url:"/Budget/RecoveryRecord",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){n.isDeleted=!t.isOk;HideLoading("#record_"+n.id);BudgetVue.refreshAfterChangeRecords(t.dateTimeOfPayment)}})}}});