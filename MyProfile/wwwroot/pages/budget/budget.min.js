var BudgetVue=new Vue({el:"#budget-vue",data:{periodType:BudgetMethods.periodType,budgetDate:null,budgetYear:null,templateID:null,template:{},columnOrderQueue:0,rows:[],footerRow:[],column:{},flatpickr:{},records:[],tableAjax:null,dataTable:null,excelDataTable:null,pageViewSettings:{version:1,isTableViewCompact:!1},isGenerateExcel:!1,totalChartsAjax:null,earningData:{},earningChart:undefined,spendingData:{},spendingChart:undefined,investingData:{},investingChart:undefined,limitsAjax:null,limitsChartsData:[],limitsCharts:[],goalsAjax:null,goalChartsData:[],goalCharts:[],bigChartsAjax:null,bigChartsData:[],bigCharts:[],bigChartHeight:310,isLoading:!1},watch:{},mounted:BudgetMethods.mounted,methods:{load:BudgetMethods.load,changeView:BudgetMethods.changeView,loadTotalCharts:BudgetMethods.loadTotalCharts,initTotalCharts:function(){this.earningChart&&this.earningChart.destroy();this.earningChart=new Chart(document.getElementById("earningChart").getContext("2d"),{type:"line",data:{datasets:[{data:this.earningData.data,borderWidth:1,backgroundColor:"rgba(2, 188, 119, .2)",borderColor:"rgba(2, 188, 119, 1)",pointBorderColor:"rgba(0,0,0,0)",pointRadius:1,lineTension:0}],labels:this.earningData.labels},options:{scales:{xAxes:[{display:!1}],yAxes:[{display:!1}]},legend:{display:!1},tooltips:{enabled:!0},responsive:!1,maintainAspectRatio:!1}});this.spendingChart&&this.spendingChart.destroy();this.spendingChart=new Chart(document.getElementById("spendingChart").getContext("2d"),{type:"line",data:{datasets:[{data:this.spendingData.data,borderWidth:1,backgroundColor:"rgba(217, 83, 79, .2)",borderColor:"rgba(217, 83, 79, 1)",pointBorderColor:"rgba(0,0,0,0)",pointRadius:1,lineTension:0}],labels:this.spendingData.labels},options:{scales:{xAxes:[{display:!1}],yAxes:[{display:!1}]},legend:{display:!1},tooltips:{enabled:!1},responsive:!1,maintainAspectRatio:!1}});this.investingChart=new Chart(document.getElementById("investmentsChart").getContext("2d"),{type:"line",data:{datasets:[{data:this.investingData.data,borderWidth:1,backgroundColor:"rgba(136, 151, 170, .2)",borderColor:"rgba(136, 151, 170, 1)",pointBorderColor:"rgba(0,0,0,0)",pointRadius:1,lineTension:0}],labels:this.investingData.labels},options:{scales:{xAxes:[{display:!1}],yAxes:[{display:!1}]},legend:{display:!1},tooltips:{enabled:!1},responsive:!1,maintainAspectRatio:!1}});setTimeout(this.resizeTotalCharts,50)},resizeTotalCharts:function(){this.earningChart&&this.earningChart.resize();this.spendingChart&&this.spendingChart.resize();this.investingChart&&this.investingChart.resize();this.refrehHeaderTable()},loadLimitCharts:BudgetMethods.loadLimitCharts,initLimitCharts:function(){for(var n=0;n<this.limitsChartsData.length;n++){let t=this.limitsChartsData[n];this.limitsCharts[n]&&this.limitsCharts[n].destroy();let i=["#4CAF50","#ededed"],r=["#4CAF50","#ededed"];t.percent1>85?(i=["#d9534f","#ededed"],r=["#d9534f","#ededed"]):t.percent1>65&&(i=["#FFD950","#ededed"],r=["#FFD950","#ededed"]);this.limitsCharts[n]=new Chart(document.getElementById(t.chartID).getContext("2d"),{type:"doughnut",data:{datasets:[{data:[t.percent1,t.percent2],backgroundColor:i,hoverBackgroundColor:r,borderWidth:0}]},options:{scales:{xAxes:[{display:!1}],yAxes:[{display:!1}]},legend:{display:!1},tooltips:{enabled:!1},cutoutPercentage:94,responsive:!1,maintainAspectRatio:!1}})}this.resizeLimitCharts();this.resizeLimitCharts()},resizeLimitCharts:function(){for(var n=0;n<this.limitsCharts.length;n++)this.limitsCharts[n]&&this.limitsCharts[n].resize();this.refrehHeaderTable()},hideLimit:function(n){return ShowLoading("#limit_"+n),$.ajax({type:"GET",url:"/Limit/ToggleLimit?id="+n+"&periodType="+this.periodType,contentType:"application/json",dataType:"json",context:n,success:function(n){HideLoading("#limit_"+this);(n.isOk=!0)&&BudgetVue.limitsChartsData.splice(BudgetVue.limitsChartsData.findIndex(n=>n.id==this),1)},error:function(){HideLoading("#limit_"+this)}})},getSectionsTitle:function(n){if(n.length>0){let i="";for(var t=0;t<n.length;t++)i+=`<li>${n[t].name}</li>`;return"<ul class='my-1 pl-3'>"+i+"<\/ul>"}return""},loadGoalCharts:BudgetMethods.loadGoalCharts,OLD_initGoalCharts:function(){for(var n=0;n<this.goalChartsData.length;n++){let t=this.goalChartsData[n];this.goalCharts[n]&&this.goalCharts[n].destroy();let i=["#4CAF50","#ededed"],r=["#4CAF50","#ededed"];t.percent<0&&(i=["#d9534f","#ededed"],r=["#d9534f","#ededed"]);this.goalCharts[n]=new Chart(document.getElementById(t.chartID).getContext("2d"),{type:"doughnut",data:{datasets:[{data:[t.percent,t.percent2],backgroundColor:i,hoverBackgroundColor:r,borderWidth:0}]},options:{scales:{xAxes:[{display:!1}],yAxes:[{display:!1}]},legend:{display:!1},tooltips:{enabled:!1},cutoutPercentage:94,responsive:!1,maintainAspectRatio:!1}})}setTimeout(this.resizeGoalCharts,10)},OLD_resizeGoalCharts:function(){for(var n=0;n<this.goalCharts.length;n++)this.goalCharts[n]&&this.goalCharts[n].resize();this.refrehHeaderTable()},addGoalMoney:function(n){GoalAddMoneyVue.addMoney(n)},hideGoal:function(n){return ShowLoading("#goal_"+n),$.ajax({type:"GET",url:"/Goal/ToggleGoal?id="+n+"&periodType="+this.periodType,contentType:"application/json",dataType:"json",context:n,success:function(n){HideLoading("#goal_"+this);(n.isOk=!0)&&BudgetVue.goalChartsData.splice(BudgetVue.goalChartsData.findIndex(n=>n.id==this),1)},error:function(){HideLoading("#goal_"+this)}})},loadBigCharts:BudgetMethods.loadBigCharts,initBigChartCharts:function(){for(var n=0;n<this.bigChartsData.length;n++){let t=this.bigChartsData[n],i=null,r=themeSettings.isDarkStyle()?"#fff":"#aaa";this.bigCharts[n]&&this.bigCharts[n].destroy();switch(t.chartTypeCodeName){case"line":case"bar":i={title:{display:!1},scales:{xAxes:[{ticks:{fontColor:r}}],yAxes:[{ticks:{callback:function(n){return new Intl.NumberFormat(UserInfo.Currency.SpecificCulture,{style:"currency",currency:UserInfo.Currency.CodeName}).format(n).split(",")[0]+" ₽"},fontColor:r,beginAtZero:!0}}]},tooltips:{callbacks:{label:function(n){return new Intl.NumberFormat(UserInfo.Currency.SpecificCulture,{style:"currency",currency:UserInfo.Currency.CodeName}).format(n.value).split(",")[0]+" ₽"}}},legend:{display:t.chartTypesEnum==1||t.chartTypesEnum==6,fontColor:r},responsive:!1,maintainAspectRatio:!1};break;case"doughnut":case"pie":i={title:{display:!1,text:t.name},tooltips:{callbacks:{label:function(n,t){let i="",r="";try{i=t.labels[n.index];r=t.datasets[0].data[n.index]}catch(u){console.log(u)}return`${i}: ${new Intl.NumberFormat(UserInfo.Currency.SpecificCulture,{style:"currency",currency:UserInfo.Currency.CodeName}).format(r).split(",")[0]} ₽`}}}}}this.bigCharts[n]=new Chart(document.getElementById(t.chartID),{type:t.chartTypeCodeName,data:{labels:t.labels,datasets:t.dataSets},options:i})}this.resizeBigCharts()},resizeBigCharts:function(){let n=0;for(var t=0;t<this.bigCharts.length;t++){let i=this.bigCharts[t];i&&(i.resize(),n=i.height)}n<300?this.bigChartHeight=310:n>=300&&n<=450?this.bigChartHeight=370:n>450&&(this.bigChartHeight=600);this.refrehHeaderTable()},toggleBigChart:function(n){return ShowLoading("#chart_"+n),$.ajax({type:"GET",url:"/Chart/ToggleChart?id="+n+"&periodType="+this.periodType+"&isBudgetPage=true",contentType:"application/json",dataType:"json",context:n,success:function(n){HideLoading("#chart_"+this);(n.isOk=!0)&&BudgetVue.bigChartsData.splice(BudgetVue.bigChartsData.findIndex(n=>n.id==this),1)},error:function(){HideLoading("#chart_"+this)}})},refresh:function(n){if((n==undefined||n=="onlyTable"||n=="runtimeData"||n=="all")&&this.templateID!="-1"&&(this.isLoading=!0,ShowLoading(".table-container"),this.load().then(function(){HideLoading(".table-container");BudgetVue.initTable();this.isLoading=!1})),n=="onlyTable")return!1;if(n=="runtimeData")return this.loadBigCharts(),this.loadTotalCharts(),this.loadLimitCharts(),!1;if(n=="onlyGoal"){ShowLoading("#goal-contrainer");this.loadGoalCharts().then(function(){HideLoading("#goal-contrainer")});return}this.loadBigCharts();this.loadTotalCharts();this.loadLimitCharts();this.loadGoalCharts()},refreshAfterChangeRecords:function(n){HistoryVue.showLastHistory();let t=moment(n);if(this.periodType==PeriodTypeEnum.Month){let n=moment(this.budgetDate,"YYYY/MM/DD");if(t.get("month")==n.get("month")&&t.get("year")==n.get("year"))return this.refresh("runtimeData")}else if(this.periodType==PeriodTypeEnum.Year&&t.get("year")==this.budgetYear)return this.refresh("runtimeData");return!1},resizeAll:function(){this.resizeTotalCharts();this.resizeLimitCharts();this.resizeBigCharts()},refrehHeaderTable:function(){this.dataTable&&this.dataTable.fixedHeader&&this.dataTable.fixedHeader.adjust();$('[data-toggle="tooltip"]').tooltip()},initTable:function(){this.dataTable=$("#table").DataTable({columnDefs:[{targets:"_all",className:"column-min-width",orderDataType:"dom-text-numeric",type:"num"},],colReorder:{realtime:!1}});this.dataTable.on("column-reorder",function(){BudgetVue.columnOrderQueue+=1;setTimeout(function(){if(BudgetVue.columnOrderQueue==1){BudgetVue.columnOrderQueue=0;let n=[];$("#table th").each(function(){let t=$(this);n.push({id:t.data("column-id"),newOrder:t.data("column-index"),oldOrder:t.data("column-order")})});$.ajax({type:"POST",url:"/Budget/TemplateChangeColumns",contentType:"application/json",data:JSON.stringify({listOrder:n,templateID:BudgetVue.template.id}),dataType:"json",success:function(){toastr.success("Изменения в шаблоне сохранены")}})}else BudgetVue.columnOrderQueue-=1},1500)});$.fn.dataTable.ext.order["dom-text-numeric"]=function(n,t){return this.api().column(t,{order:"index"}).nodes().map(function(n){return $(n).find("span[data-value]").data("value")})};setTimeout(function(){$('[data-toggle="tooltip"]').tooltip()},1e3)},toExcel:function(){this.isGenerateExcel=!0;BudgetVue.excelDataTable=$("#excel-table").DataTable({dom:"Bfrtip",buttons:["excelHtml5"],retrieve:!0});setTimeout(function(){$(".buttons-excel").click();BudgetVue.isGenerateExcel=!1;setTimeout(function(){BudgetVue.excelDataTable.destroy()},2e3)},100)},getCellContent:function(n,t,i){return this.periodType==PeriodTypeEnum.Month?`<div class="cell-head">${this.getCellActions(n,t,i)+this.getCellValue(n,t,i)}</div>
                    <div class="cell-footer mt-1">
                        <span class="cell-reminder-icons"
                                onclick="ReminderVue.showReminders('${n.currentDate}')">${this.getRemindersIcons(n)}</span>
                        <span class="cell-section-icons"></span>
                    </div>`:`<div class="cell-head">${this.getCellActions(n,t,i)+this.getCellValue(n,t,i)}</div>
                    <div class="cell-footer mt-1"><span class="cell-reminder-icons"></span><span class="cell-section-icons"></span></div>`},getCellFooterContent:function(n,t){return this.getCellFooterActions(t)+this.getCellValue(n,t)},getCellActions:function(n,t,i){return this.periodType==PeriodTypeEnum.Month?n.templateColumnType==2?`
                    <span class="float-left cell-actions">
                        <i class="ion ion-md-add add-cell-action" onclick="RecordVue.showModal('${n.currentDate}', 'BudgetVue.refreshAfterChangeRecords')" title="Добавить запись" ></i>
                        <i class="fas fa-history show-history-cell-action pl-1" onclick="BudgetVue.showHistory(${i}, ${t},'${n.currentDate}', event)" title="Посмотреть историю"></i>
                        <i class="remind-cell-action">+<i class="fas fa-bell" onclick="ReminderVue.addReminders('${n.currentDate}')" title="Добавить напоминание"></i></i>
                    </span>`:`
                    <span class="float-left cell-actions">
                        <i class="fas fa-history show-history-cell-action pl-1" onclick="BudgetVue.showHistory(${i}, ${t},'${n.currentDate}', event)" title="Посмотреть историю"></i>
                    </span>`:`
                    <span class="float-left cell-actions">
                        <i class="fas fa-history show-history-cell-action pl-1" onclick="BudgetVue.showHistory(${i}, ${t},'${n.currentDate}', event)"></i>
                    </span>`},getCellFooterActions:function(n){return`
                <span class="float-left cell-actions">
                    <i class="fas fa-history show-history-cell-action pl-1" onclick="BudgetVue.clickFooterCell(${n})"></i>
                </span>`},getCellValue:function(n,t,i){if(n.value.indexOf(",")){let r=n.value.split(","),u=` data-type="${n.templateColumnType}" data-value='${n.naturalValue}'`;return i>=0?r.length==2?`<span ${u} onclick="BudgetVue.showHistory(${i}, ${t},'${n.currentDate}', event)"> 
                                ${r[0]}
                                <span class="money-muted">,${r[1]}</span>
                            </span> `:`<span ${u} onclick="BudgetVue.showHistory(${i}, ${t},'${n.currentDate}', event)"> ${n.value}</span>`:r.length==2?`<span ${u} onclick="BudgetVue.clickFooterCell(${t})" class="font-weight-semibold"> 
                                ${r[0]}
                                <span class="money-muted">,${r[1]}</span>
                            </span> `:`<span ${u} onclick="BudgetVue.clickFooterCell(${t})" class="font-weight-semibold"> ${n.value}</span>`}return`<span ${generalValue} onclick="BudgetVue.showHistory(${i}, ${t},'${n.currentDate}', event)"> ${n.value}</span>`},getHeaderTitle:function(n){if(n.templateColumnType==1){let i="";for(var t=0;t<n.templateBudgetSections.length;t++)i+=`<li>${n.templateBudgetSections[t].sectionName}</li>`;return"<ul class='my-1 pl-3'>"+i+"<\/ul>"}return""},getRemindersIcons:function(n){if(n.templateColumnType==2){let i=``;for(var t=0;t<n.reminders.length;t++){let r=n.reminders[t],f="",u="",e="";r.isRepeat&&(u='<i class="fas fa-sync" style="font-size: 8px; color: gray; padding-top: -3px; position: absolute;"><\/i>');r.count>1&&(f=r.count,r.isRepeat&&(u="",e='<i class="fas fa-sync" style="font-size: 8px; color: gray; padding-top: -3px;"><\/i>'));i+=`<span class="mr-1"><i class="${r.cssIcon}" title="${r.titles}"></i>${u}<span class="reminder-count">${f}</span>${e}</span>`}return i}return""},mouseenterCell:function(n){if(n.target.nodeName=="TD"&&n.target.classList.contains("show-actions")==!1){n.target.classList.add("show-actions");return}},mouseleaveCell:function(n){if(n.target.nodeName=="TD"&&n.target.classList.contains("show-actions")){n.target.classList.remove("show-actions");return}},showHistory:function(n,t,i,r){let f=[];if(this.template.columns[t].templateColumnType==1)f=this.template.columns[t].templateBudgetSections.map(n=>n.sectionID),this.stylingClickedCells(r,"td");else if([2,3,4,7].indexOf(this.template.columns[t].templateColumnType)>=0){for(var e=0;e<this.template.columns.length;e++)f=f.concat(this.template.columns[e].templateBudgetSections.map(n=>n.sectionID));this.stylingClickedCells(r,"tr")}else return;let u={sections:f};return this.periodType==PeriodTypeEnum.Month?(u.startDate=moment(this.budgetDate,"YYYY/MM/DD").add(n,"days").format(),u.endDate=moment(this.budgetDate,"YYYY/MM/DD").add(n+1,"days").add(-1,"minutes").format()):this.periodType==PeriodTypeEnum.Year&&(u.startDate=moment(i,"YYYY/MM/DD").format(),u.endDate=moment(i,"YYYY/MM/DD").endOf("month").format()),HistoryVue.showHistory(u,i)},clickFooterCell:function(n){let t={sections:[]};if(this.template.columns[n].templateColumnType==TemplateColumnTypeEnum.BudgetSection)t.sections=this.template.columns[n].templateBudgetSections.map(n=>n.sectionID),this.stylingClickedCells(event,"td_s",n);else if(this.template.columns[n].templateColumnType==TemplateColumnTypeEnum.DaysForMonth||this.template.columns[n].templateColumnType==TemplateColumnTypeEnum.MonthsForYear)t.sections=this.template.columns.map(n=>n.templateBudgetSections.map(n=>n.sectionID)).flat(),this.stylingClickedCells(event,"table",n);else return null;return this.periodType==PeriodTypeEnum.Month?(t.startDate=moment(this.budgetDate).format(),t.endDate=moment(this.budgetDate).endOf("month").format()):this.periodType==PeriodTypeEnum.Year&&(t.startDate=`${this.budgetYear}-01-01T00:00:01+00:00`,t.endDate=`${this.budgetYear}-12-31T23:59:59+00:00"`),HistoryVue.showHistory(t)},stylingClickedCells:function(n,t,i){this.clearAllStyle();t=="td"?$(n.target).closest("td").addClass("table-primary"):t=="tr"?$(n.target).closest("tr").addClass("table-primary"):t=="td_s"?$("#table td:nth-child("+ ++i+")").addClass("table-primary"):t=="table"&&$("#table td").addClass("table-primary")},clearAllStyle:function(){let t=[...document.getElementsByClassName("table-primary")];for(var n=0;n<t.length;n++)t[n].classList.remove("table-primary")},savePageSettings:function(){localStorage.setItem("pageViewSettings",JSON.stringify(this.pageViewSettings))},savePageSettings:function(){localStorage.setItem("pageViewSettings",JSON.stringify(this.pageViewSettings))},getPageSettings:function(){let n=localStorage.getItem("pageViewSettings");if(n!=null)try{n=JSON.parse(n);this.pageViewSettings=n}catch(t){}},getSectionsTitle:function(n){if(n&&n.length>0){let i="";for(var t=0;t<n.length;t++)i+=`<li>${n[t].name}</li>`;return"<ul class='my-1 pl-3'>"+i+"<\/ul>"}return""},getCurrencyValue:function(n){return new Intl.NumberFormat(UserInfo.Currency.SpecificCulture,{style:"currency",currency:UserInfo.Currency.CodeName}).format(n).split(",")[0]+" ₽"}}});