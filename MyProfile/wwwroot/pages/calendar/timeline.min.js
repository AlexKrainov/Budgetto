var vueTimeline,gMapOptions;const dateFormatForFilter="DD.MM.YYYY HH:mm",dateFormatForServer="DD.MM.YYYY HH:mm",dateFormatForCalendar="DD.MM.YYYY",dateFormatForTimeLine="DD.MM.YYYY",datetimeFormatForTimeLine="DD.MM.YYYY HH:mm:ss",timeFormatForTimeLine="HH:mm:ss",timeFormatForTimeLineDelay="mm:ss:ms",separatorDateRange=" - ";$(function(){filter.init_filter();vueTimeline=new Vue({el:"#timeline_records",data:{records:[],currentDate:"",sections:[]},updated:function(){this.$nextTick(function(){})},mounted:function(){this.sections=$("#Sections").data("items")},methods:{add:function(n){for(var t=0;t<n.length;t++){n[t].delay=0;n[t].date="";let i=moment(n[t].dateTimeOfPayment).format(dateFormatForTimeLine);i!=this.currentDate&&(this.currentDate=i,n[t].date=i);this.records.push(n[t])}},titleClick:function(n,t,i,r,u){i=i*1;r=r*1;i==0&&r==0&&!u},GetDateByFormat:function(n,t){return GetDateByFormat(n,t)},edit:function(n){RecordVue.editByElement(n,timeline.calendar_day_click_after_change_record)},remove:function(n){return ShowLoading("#record_"+n.id),$.ajax({type:"POST",url:"/Budget/RemoveRecord",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){n.isDeleted=t.isOk;HideLoading("#record_"+n.id)}})},recovery:function(n){return ShowLoading("#record_"+n.id),$.ajax({type:"POST",url:"/Budget/RecoveryRecord",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){n.isDeleted=!t.isOk;HideLoading("#record_"+n.id)}})},getCurrencyValue:function(n){let t=new Intl.NumberFormat(UserInfo.Currency.SpecificCulture,{style:"currency",currency:UserInfo.Currency.CodeName}).format(n.money);if(UserInfo.Currency.ID!=n.currencyID)try{t+=" ("+new Intl.NumberFormat(n.currencySpecificCulture,{style:"currency",currency:n.currencyCodeName}).format(CalculateExpression(n.tag))+")"}catch(i){}return t}}});timeline.search_click()});var filter={date:{},data:{startDate:moment().subtract(6,"days").startOf("day"),endDate:moment()},init_filter:function(){$("#Sections").select2();$("#filter").change(function(){timeline.search_click()})},serialize:function(n){filter.data=$("#filter").serializeObject();filter.data.Count=$("#Count").val("0").val();filter.data.isAmount=$("#isAmount").prop("checked");filter.data.isConsiderCollection=$("#isConsiderCollection").prop("checked");$("button[data-year="+moment().get("year")+"]").length>0&&n&&calendar.before_loading($("button[data-year="+moment().get("year")+"]"),moment().get("year"))},selectAll:function(){$("#Sections option").prop("selected",!0);$("#Sections").trigger("change")},unselectAll:function(){$("#Sections").val(null).trigger("change")},selectOnlyType:function(n){$("#Sections").val(null);$("#Sections").val(vueTimeline.sections.filter(t=>t.SectionTypeID==n).map(n=>n.ID)).trigger("change")}},timeline={isLoading:!0,search_click:function(){filter.serialize(!0);timeline.init()},calendar_day_click_after_change_record:function(n){n=moment(n);timeline.calendar_day_click(n.date(),n.get("months"),n.get("year"));calendar.before_loading($("button[data-year="+moment().get("year")+"]"),moment().get("year"))},calendar_day_click:function(n,t,i){filter.serialize(!1);filter.data.StartDate=moment(new Date(i,t,n,00,00)).format();filter.data.EndDate=moment(new Date(i,t,n,23,59,59)).format();timeline.init()},init:function(){this.isLoading=!1;vueTimeline.records=[];vueTimeline.currentDate="";this.up_element("_","_");this.loading_records()},before_loading:function(){timeline.toggleSpinner(!0);timeline.isLoading=!0;$("#to_up").show();filter.data.Count=$("#Count").val()},loading_records:function(){return timeline.before_loading(),$.ajax({type:"POST",url:"/Budget/LoadingRecordsForCalendar",data:JSON.stringify(filter.data),contentType:"application/json",dataType:"json",success:function(n){timeline.draw_records(n)}})},after_loading:function(n){timeline.toggleSpinner(n);timeline.isLoading=!1},end_loading:function(){timeline.isLoading=!0;timeline.toggleSpinner(!1)},draw_records:function(n){$("#Count").val(vueTimeline.records.length+n.take);setTimeout(function(){vueTimeline.add(n.data);n.isEnd==!0&&timeline.end_loading();timeline.after_loading(!1)},400);timeline.up_element($("#Count").val(),n.count)},scroll_event:function(){$(window).scroll(function(n){var t=$(document).height(),i=Math.ceil($(window).height()+$(window).scrollTop());i-t==0&&timeline.isLoading==!1&&(n.preventDefault(),timeline.loading_records())})},scroll_event_destroy:function(){$(window).off("scroll")},up_element:function(n,t){$("#to_up .badge").text(n+"/"+t)},toggleSpinner:function(n){n?ShowLoading("#filter"):HideLoading("#filter")}},calendar={calHeatMap:undefined,range:12,sizes:[],resize:function(){let t=parseInt($("#cal-heatmap-container").width());for(var n=0;n<calendar.sizes.length;n++)t<=calendar.sizes[n].size.to&&t>=calendar.sizes[n].size.from&&(calendar.range=calendar.sizes[n].size.range)},before_loading:function(n,t){$(n).parent().find("button").removeClass("active");$(n).addClass("active");calendar.toggleSpinner(!0);calendar.calHeatMap!=undefined&&(calendar.calHeatMap.destroy(),$("#cal-heatmap").empty());filter.data.Year=t;calendar.loading_dates(filter.data)},loading_dates:function(n){return $.ajax({type:"POST",url:"/Budget/GetCountRecordsByYear",data:JSON.stringify(n),contentType:"application/json",dataType:"json",success:function(n){calendar.after_loading(n)}})},after_loading:function(n){var u=function(t){let r={},u,i,f=calendar.getAllDatesInYear(n.year);return jQuery.each(f,function(n,f){let e=t.find(n=>moment(n.date).format("YYYY-MM-DD")==f.dateFormat);u=moment(f.date).unix();i=e==undefined?0:e.count;r[u]=i}),r};let t="#domainDynamicDimension-next",i="#domainDynamicDimension-previous";calendar.range==12?(t=!1,i=!1,$("#btn_move_calendar").hide()):$("#btn_move_calendar").show();let r=[];r=$("#isAmount").prop("checked")?["₽","₽"]:["запись","записей"];calendar.calHeatMap=new CalHeatMap;calendar.calHeatMap.init({start:new Date(n.year,0),range:calendar.range,domain:"month",subDomain:"day",cellSize:15,cellRadius:3,domainGutter:5,subDomainTextFormat:"%d",considerMissingDataAsZero:!0,data:n.dates,afterLoadData:u,highlight:["now"],displayLegend:!1,legend:n.legend,legendColors:{min:"#DAF1FF",max:"#26B4FF",empty:"#f3f3f4",base:"#DAF1FF",overflow:"#DAF1FF"},tooltip:!0,nextSelector:t,previousSelector:i,subDomainDateFormat:function(n){return moment(n).format(dateFormatForCalendar)},itemName:r,onClick:calendar.day_click,onComplete:calendar.onComplete,domainLabelFormat:calendar.domainLabelFormat})},day_click:function(n,t){if(t==0)return!0;let i=moment(n);timeline.calendar_day_click(i.get("date"),i.get("month"),i.get("year"))},onComplete:function(){},domainLabelFormat:function(n){return moment(n).format("MMMM")},getAllDatesInYear:function(n){var i,t;let r=[];for(i=0;i<=12;i++)for(t=new Date(n,i,1);t.getMonth()===i;)r.push({date:moment(t),count:0,dateFormat:moment(t).format("YYYY-MM-DD")}),t.setDate(t.getDate()+1);return r},toggleSpinner:function(){}};$.getJSON("/json/timeline-calendar-resize.json",function(){}).done(function(n){calendar.sizes=n.calendar_size;calendar.resize()});