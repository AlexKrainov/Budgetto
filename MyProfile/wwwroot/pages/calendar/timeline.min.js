const dateFormatForServer="DD.MM.YYYY HH:mm",dateFormatForCalendar="DD.MM.YYYY",dateFormatForTimeLine="DD.MM.YYYY";var vueTimeline=new Vue({el:"#timeline_records",data:{records:[],currentDate:"",sections:[],userTags:[],filter:{isSection:!0,Count:0,isAmount:!0,isConsiderCollection:!1,isCount:!1,Year:moment().get("year"),sections:[],tags:[]},searchSection:null,countRefresh:0,tagify:null},mounted:function(){this.init_filter()},methods:{init_filter:function(){$.ajax({type:"GET",url:"/Section/GetSectins",data:null,contentType:"application/json; charset=utf-8",dataType:"json",context:this,success:function(n){return n.isOk&&(this.sections=n.sections),this.serialize(!0),n},error:function(n,t,i){console.log(i)}},this);$.ajax({type:"GET",url:"/Common/GetUserTags",contentType:"application/json; charset=utf-8",dataType:"json",context:this,success:function(n){return n.isOk&&(this.userTags=n.tags,this.tagify=new Tagify(document.querySelector('input[name="tags"]'),{whitelist:this.userTags,enforceWhitelist:!0,delimiters:null,dropdown:{maxItems:20,classname:"tags-look",enabled:0,closeOnSelect:!1},callbacks:{add:this.addTag,remove:this.removeTag}}),this.selectAllTags()),n},error:function(n,t,i){console.log(i)}})},loadingDatesForCalendar:function(){vueTimeline.countRefresh+=1;setTimeout(function(){vueTimeline.countRefresh<=1?(vueTimeline.records=[],vueTimeline.currentDate="",vueTimeline.serialize(!0),vueTimeline.countRefresh=0):vueTimeline.countRefresh-=1},1e3)},init:function(){vueTimeline.records=[];vueTimeline.currentDate="";this.loading_records()},loading_records:function(){return this.toggleSpinner(!0),$.ajax({type:"POST",url:"/Budget/LoadingRecordsForCalendar",data:JSON.stringify(vueTimeline.filter),contentType:"application/json",dataType:"json",success:function(n){vueTimeline.draw_records(n)},error:function(){vueTimeline.toggleSpinner(!1);toastr.error("Ошибка сервера. Повторите запрос позже.")}})},after_loading:function(n){vueTimeline.toggleSpinner(n)},draw_records:function(n){n.isOk!=!1&&setTimeout(function(){vueTimeline.add(n.data);vueTimeline.after_loading(!1)},400)},toggleSpinner:function(n){n?ShowLoading("#filter"):HideLoading("#filter")},serialize:function(n){this.filter.sections=this.sections.filter(n=>n.isSelected).map(n=>n.id);this.filter.tags=this.userTags.filter(n=>n.isShow==!1).map(n=>n.id);this.filter.Year=$(".active[data-year]").attr("data-year");this.filter.Year>0&&n&&calendar.before_loading(this.filter.Year)},changeSwitch:function(){vueTimeline.loadingDatesForCalendar()},onChooseSection:function(){vueTimeline.loadingDatesForCalendar()},selectAllTags:function(){this.userTags=this.userTags.map(function(n){return n.isShow=!1,n});this.tagify.addTags(this.userTags);vueTimeline.loadingDatesForCalendar()},unselectAllTags:function(){this.tagify.removeAllTags();for(var n=0;n<this.userTags.length;n++)this.userTags[n].isShow=!0;vueTimeline.loadingDatesForCalendar()},selectedTag:function(n){this.tagify.addTags([n]);n.isShow=!1;vueTimeline.loadingDatesForCalendar()},addTag:function(n){let t=n.detail.data;if(t.isShow){let n=this.userTags.findIndex(n=>n.id==t.id);n!=-1&&(this.userTags[n].isShow=!1)}},removeTag:function(n){if(n.detail.data&&n.detail.data.id){let t=this.userTags.findIndex(t=>t.id==n.detail.data.id);t>=0&&(this.userTags[t].isShow=!0)}vueTimeline.loadingDatesForCalendar()},selectAll:function(){for(var n=0;n<this.sections.length;n++)this.sections[n].isSelected=!0;vueTimeline.loadingDatesForCalendar()},unselectAll:function(){for(var n=0;n<this.sections.length;n++)this.sections[n].isSelected=!1;vueTimeline.loadingDatesForCalendar()},selectOnlyType:function(n){for(var t=0;t<this.sections.length;t++)this.sections[t].isSelected=this.sections[t].sectionTypeID==n;vueTimeline.loadingDatesForCalendar()},add:function(n){for(var t=0;t<n.length;t++){n[t].delay=0;n[t].date="";let i=moment(n[t].dateTimeOfPayment).format(dateFormatForTimeLine);i!=this.currentDate&&(this.currentDate=i,n[t].date=i);this.records.push(n[t])}},titleClick:function(n,t,i,r,u){i=i*1;r=r*1;i==0&&r==0&&!u},GetDateByFormat:function(n,t){return GetDateByFormat(n,t)},edit:function(n){RecordVue.editByElement(n,calendar.calendar_day_click_after_change_record)},descriptionBuilder:function(n){return TagBuilder.toDescription(n)},remove:function(n){return ShowLoading("#record_"+n.id),$.ajax({type:"POST",url:"/Budget/RemoveRecord",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){n.isDeleted=t.isOk;HideLoading("#record_"+n.id)}})},recovery:function(n){return ShowLoading("#record_"+n.id),$.ajax({type:"POST",url:"/Budget/RecoveryRecord",data:JSON.stringify(n),context:n,contentType:"application/json",dataType:"json",success:function(t){n.isDeleted=!t.isOk;HideLoading("#record_"+n.id)}})},getCurrencyValue:function(n){let t=new Intl.NumberFormat(UserInfo.Currency.SpecificCulture,{style:"currency",currency:UserInfo.Currency.CodeName}).format(n.money);if(UserInfo.Currency.ID!=n.currencyID)try{t+=" ("+new Intl.NumberFormat(n.currencySpecificCulture,{style:"currency",currency:n.currencyCodeName}).format(CalculateExpression(n.tag))+")"}catch(i){}return t}}}),calendar={calHeatMap:undefined,range:12,sizes:[],calendar_day_click_after_change_record:function(n){n=moment(n);calendar.calendar_day_click(n.date(),n.get("months"),n.get("year"));calendar.before_loading($("button[data-year="+moment().get("year")+"]"),moment().get("year"))},calendar_day_click:function(n,t,i){vueTimeline.serialize(!1);vueTimeline.filter.StartDate=moment(new Date(i,t,n,00,00)).format();vueTimeline.filter.EndDate=moment(new Date(i,t,n,23,59,59)).format();vueTimeline.init()},before_loading:function(n){$("[data-year]").removeClass("active");$("[data-year="+n+"]").addClass("active");calendar.calHeatMap!=undefined&&(calendar.calHeatMap.destroy(),$("#cal-heatmap").empty());vueTimeline.serialize(!1);calendar.loading_dates()},loading_dates:function(){return vueTimeline.toggleSpinner(!0),$.ajax({type:"POST",url:"/Budget/GetCountRecordsByYear",data:JSON.stringify(vueTimeline.filter),contentType:"application/json",dataType:"json",success:function(n){calendar.after_loading(n);vueTimeline.toggleSpinner(!1)}})},after_loading:function(n){var u=function(t){let r={},u,i,f=calendar.getAllDatesInYear(n.year);return jQuery.each(f,function(n,f){let e=t.find(n=>moment(n.date).format("YYYY-MM-DD")==f.dateFormat);u=moment(f.date).unix();i=e==undefined?0:e.count;r[u]=i}),r};let t="#domainDynamicDimension-next",i="#domainDynamicDimension-previous";calendar.range==12?(t=!1,i=!1,$("#btn_move_calendar").hide()):$("#btn_move_calendar").show();let r=[];r=$("#isAmount").prop("checked")?["₽","₽"]:["запись","записей"];calendar.calHeatMap=new CalHeatMap;calendar.calHeatMap.init({start:new Date(n.year,0),range:calendar.range,domain:"month",subDomain:"day",cellSize:15,cellRadius:3,domainGutter:5,subDomainTextFormat:"%d",considerMissingDataAsZero:!0,data:n.dates,afterLoadData:u,highlight:["now"],displayLegend:!1,legend:n.legend,legendColors:{min:"#DAF1FF",max:"#26B4FF",empty:"#f3f3f4",base:"#DAF1FF",overflow:"#DAF1FF"},tooltip:!0,nextSelector:t,previousSelector:i,subDomainDateFormat:function(n){return moment(n).format(dateFormatForCalendar)},itemName:r,onClick:calendar.day_click,onComplete:calendar.onComplete,domainLabelFormat:calendar.domainLabelFormat})},day_click:function(n,t){if(t==0)return!0;let i=moment(n);calendar.calendar_day_click(i.get("date"),i.get("month"),i.get("year"))},onComplete:function(){},domainLabelFormat:function(n){return moment(n).format("MMMM")},getAllDatesInYear:function(n){var i,t;let r=[];for(i=0;i<=12;i++)for(t=new Date(n,i,1);t.getMonth()===i;)r.push({date:moment(t),count:0,dateFormat:moment(t).format("YYYY-MM-DD")}),t.setDate(t.getDate()+1);return r},resize:function(){let t=parseInt($("#cal-heatmap-container").width());for(var n=0;n<calendar.sizes.length;n++)t<=calendar.sizes[n].size.to&&t>=calendar.sizes[n].size.from&&(calendar.range=calendar.sizes[n].size.range)}};$.getJSON("/json/timeline-calendar-resize.json",function(){}).done(function(n){calendar.sizes=n.calendar_size;calendar.resize()});